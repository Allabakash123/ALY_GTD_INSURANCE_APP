<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    {%load static %}
    <link rel="stylesheet" href="{% static 'ALY_GTD/styles.css' %}" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <title>Fleet Master</title>
     <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #f0f0f0;
        margin: 0;
      }

      .container {
        background-color: #e6f2ff;
        border: 1px solid #99ccff;
        padding: 10px;
        max-width: 100%;
        overflow-x: hidden; /* Prevent horizontal overflow */
      }

      h1 {
        background-color: #0066cc;
        color: white;
        padding: 5px 10px;
        font-weight: bold;
        font-size: 17px;
      }

      .fleet-master-nav {
        /* position: sticky; */
        top: 0;
        /* z-index: 1020; */
        background-color: transparent !important;
        border: 2px solid #0d6efd;
        border-radius: 5px;
        padding-top: 0rem;
        padding-bottom: 0rem;
        margin-bottom: 5px;
        min-height: 30px;
        width: 100%; /* Ensure full width */
      }

      .fleet-master-nav .navbar-brand,
      .fleet-master-nav .nav-link {
        color: #0d6efd !important;
      }

      .fleet-master-nav .navbar-toggler-icon {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba(13, 110, 253, 0.75)' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
      }

      .fleet-master-nav .navbar-toggler {
        border-color: #0d6efd;
      }

      #fleetMasterContent .container {
        margin-top: 20px;
      }
      .fleet-master-nav .nav-link {
        padding: 0;
      }
      .fleet-master-nav .nav-link i {
        font-size: 20px;
        padding: 0px;
      }

      .fleet-master-nav .nav-link span {
        font-size: 12px;
      }

      .navbar-nav {
        width: 100%;
      }

      .nav-item {
        display: flex;
        align-items: center;
      }

      .nav-link {
        white-space: nowrap;
      }
      .fleet-master-nav .d-flex.flex-column {
        align-items: center;
        justify-content: center;
      }

      #fleetMasterContent h1 {
        margin-top: 0;
      }

      @media (max-width: 991px) {
        .navbar-nav {
          flex-direction: column;
        }

        .d-flex.justify-content-between {
          flex-direction: column;
        }
      }

      .search-container {
        width: 100%;
        max-width: 400px;
        position: relative;
      }

      #searchInput {
        width: 350px;
        height: 50px;
        margin-left: 100px;
        padding: 10px 40px 10px 15px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 16px;
      }

      .search-icon {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #888;
      }

      .search-results-container {
        position: absolute;
        top: 100%;
        left: 0;
        min-width: 1200px;
        background-color: white;
        border: 2px solid #ccc;
        border-top: none;
        border-radius: 0 0 5px 5px;
        display: none;
        z-index: 1000;
        margin: 10px;
        max-height: 400px;
        overflow-y: auto;
      }

      .search-results-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 15px;
        background-color: #99ccff;
        border-bottom: 1px solid #ccc;
        position: sticky;
        top: 0;
        z-index: 2;
        color: black;
        height: 35px;
      }

      .close-icon {
        cursor: pointer;
      }

      .search-results {
        max-height: 200px;
        overflow-y: auto;
        list-style-type: none;
        padding: 0;

        width: 100%;
        border-collapse: collapse;
      }

      .search-results li {
        padding: 10px 15px;
        cursor: pointer;
      }
      .search-results thead {
        position: sticky !important;
        top: 41px; /* Adjust this value to match the height of your search-results-header */
        z-index: 1;
        background-color: #f0f0f0;
      }

      .search-results li:hover {
        background-color: #f0f0f0;
      }

      .search-results tr:hover {
        background-color: #f5f5f5;
      }

      .search-results td,
      .search-results th {
        padding: 10px 15px;
        text-align: left;
        border: 1px solid #ddd;
      }

      .search-results th {
        padding-right: 40px;
        text-align: center;
        position: sticky;
        top: 41px;
      }

      .search-results td {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 200px;
        padding-right: 40px;
      }

      .vehicle-info {
        display: flex;
        padding: 10px;
        background-color: #f0f8ff;
        border: 1px solid #99ccff;
        margin-top: 10px;
      }

      .left-column,
      .center-column,
      .right-column {
        flex: 0.43;
        min-width: 400px;
        padding: 0 10px;
      }

      .center-column {
        margin-top: 3rem;
      }
      .right-column {
        flex: 0.4;
        margin-left: 20px;
        margin-top: 2.5rem;
      }

      .form-group {
        margin-bottom: 5px;
        display: flex;
        align-items: center;
      }

      label {
        width: 150px;
        font-weight: bold;
        font-size: 0.9em;
      }

      input,
      select {
        flex: 0.8;
        padding: 2px;
        border: 1px solid #ccc;
        height: 36px;
      }

      .comments-section {
        margin-bottom: 20px;
      }

      .comments-section textarea {
        width: 100%;
        height: 100px;
        margin-top: 5px;
        padding: 10px;
      }

      .button-group {
        display: flex;
        flex-direction: column;
      }

      button {
        background-color: #f0f0f0;
        border: 1px solid #ccc;
        padding: 5px 10px;
        margin-bottom: 5px;
      }

      .tabs {
        padding: 5px 5px 0 5px;
        border: 1px solid #b8b8b8;
        border-bottom: none;
      }

      .tab {
        display: inline-block;
        padding: 5px 10px;
        background-color: #99ccff;
        border: 1px solid #b8b8b8;
        border-bottom: none;
        cursor: pointer;
        margin-right: 2px;
        border-top-left-radius: 4px;
        border-top-right-radius: 4px;
      }

      .tab.active {
        background-color: #0a81f8;
        border-bottom: 1px solid #fff;
        position: relative;
        top: 1px;
        color: #fbfbfb;
      }

      .tab-content {
        border: 1px solid #78a7d6;
        padding: 0px;
        margin: 20px;
        display: none;
        margin: 20px 20px;
        border-radius: 5px;
      }

      .tab-content.active {
        display: block;
      }

      .tab-content table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
      }

      .tab-content th,
      .tab-content td {
        border: 1px solid #ccc;
        text-align: center;
        padding: 5px;
      }

      .tab-content th {
        color: #000;
        background-color: #f0f0f0;
        position: sticky;
        top: 0;
        z-index: 1;
      }

      .form-control {
        width: 95%;
        padding: 5px;
        margin-left: 5px;
      }

      .table-container {
        width: 100%;
        min-height: 300px;
        overflow-y: auto;
        /* margin: 2rem 2rem; */
        position: relative;
      }

      .tab-container {
        border: 1px solid #99ccff;
        border-radius: 5px;
        margin-top: 5px;
      }

      .table-container::-webkit-scrollbar {
        width: 14px;
      }

      .table-container::-webkit-scrollbar-track {
        background: #f1f1f1;
      }

      .table-container::-webkit-scrollbar-thumb {
        background: #888;
      }

      .table-container::-webkit-scrollbar-thumb:hover {
        background: #555;
      }

      .table-container::-webkit-scrollbar-button {
        display: block;
        height: 14px;
        width: 14px;
        background-color: #ccc;
      }

      .table-container::-webkit-scrollbar-button:vertical:start:decrement {
        background: linear-gradient(130deg, #fff 40%, rgba(0, 0, 0, 0) 41%),
          linear-gradient(230deg, #fff 40%, rgba(0, 0, 0, 0) 41%),
          linear-gradient(0deg, #fff 30%, rgba(0, 0, 0, 0) 31%);
        background-color: #ccc;
      }

      .table-container::-webkit-scrollbar-button:vertical:end:increment {
        background: linear-gradient(310deg, #fff 40%, rgba(0, 0, 0, 0) 41%),
          linear-gradient(50deg, #fff 40%, rgba(0, 0, 0, 0) 41%),
          linear-gradient(180deg, #fff 30%, rgba(0, 0, 0, 0) 31%);
        background-color: #ccc;
      }

      .table-container::-webkit-scrollbar-button:horizontal:start:decrement,
      .table-container::-webkit-scrollbar-button:horizontal:end:increment {
        display: none;
      }

      textarea {
        height: 150px !important;
      }

      .serch-group input {
        width: 323px;
      }

      button i {
        margin-left: 10px;
        margin-right: 5px;
        margin-top: 4px;
        border-radius: 48%;
        padding-top: 10px;
        font-size: 14px;
        color: #f5f6f7;
      }

      .button-btn {
        margin-top: 10px;
        float: left;
        margin-left: 20px;
        padding: 10px 20px;
        font-weight: bold;
        font-size: 15px;
        color: #fff;
        background-color: rgb(0, 149, 255);
        border: none;
        border-radius: 5px;
      }
      .button-btns {
        margin-top: 10px;
        float: left;
        margin-left: 20px;
        padding: 10px 20px;
        font-weight: bold;
        font-size: 15px;
        color: #fff;
        background-color: rgb(255, 0, 0);
        border: none;
        border-radius: 5px;
      }
    

      .file-input-container {
        display: flex;
        align-items: center;
     

      }

      .file-button {
        background-color: #0c0c0c;
        border: 1px solid #080808;
        padding: 5px 10px;
        cursor: pointer;
      }

      .file-name {
        margin-left: 10px;
        font-size: 0.9em;
        color: #000;
        text-decoration: underline;
      }

      .action-btn {
        margin-left: 10px;
        padding: 0px 20px;
        font-weight: bold;
        font-size: 15px;
        color: #000;
        background-color: #99ccff;
        border: none;
        border-radius: 5px;
        margin-bottom: 1rem;
        margin-top: 1rem;
        height: 55px;
        width: 500px;
      }

      .attachment-btn {
        margin-left: 10px;
        padding: 0px 20px;
        font-weight: bold;
        font-size: 15px;
        color: #000;
        background-color: #99ccff;
        border: none;
        border-radius: 5px;
        height: 55px;
        width: 500px;
      }
      .button-group {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .file-input-container {
        display: flex;
        align-items: center;
        background-color: #99ccff;
        border: 1px solid #ccc;
        border-radius: 5px;
        padding: 5px;
        height: 55px;
        margin-left: 20px;
        margin-right:10px;
        width:500px;
      }
      .file-input {
        display: none;
      }

      .file-label {
        background-color: #4caf50;
        color: black;
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
        text-align: center;
      }

      .file-label:hover {
        background-color: #45a049;
      }

      .file-name {
        flex-grow: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .button-submit {
        margin-top: 20px;
        padding-left: 35px;
        font-weight: bold;
        margin: 0 auto;
        width: 200px;
        font-size: 15px;
        color: #fff;
        background-color: #99ccff;
        border: none;
        border-radius: 5px;
        height: 55px;
        text-align: center;
      }
      .button-submit:hover {
        background-color: #0056b3;
      }

      .sec-nav {
        display: flex;
        width: 90vw;
        justify-content: space-between;
      }

      .add-icon,
      .del-icon {
        width: 25px;
        height: 30px;
      }

      .permit-colour-header,
      .permit-colour-cell {
        width: 0;
        padding: 0;
        border: none;
        overflow: hidden;
      }

      .permit-colour-header.active,
      .permit-colour-cell.active {
        width: 150px;
        padding: 8px;
        border: 1px solid #ddd;
      }
      input[type="file"] {
        flex: 1;
        max-width: calc(100% - 120px); /* Adjust based on your dropdown width */
      }

      .button-nav {
        display: flex;
        flex-direction: row;
        width: 90px;
        margin-top: 10px;

        input[type="file"],
        .file-list,
        .file-list * {
          color: black !important;
        }

        #insuranceTable input[type="file"],
        #gpsTable input[type="file"],
        #permitsTable input[type="file"],
        #insuranceTable .file-list,
        #gpsTable .file-list,
        #permitsTable .file-list,
        #insuranceTable .file-list *,
        #gpsTable .file-list *,
        #permitsTable .file-list * {
          color: black !important;
        }
      }

      .nav-btn {
        border: 1px solid #ccc;
        background-color: #f8f9fa;
        border-radius: 5px;
        padding: 5px 10px;
        display: flex;
        align-items: center;
        margin-right: -10px;
        margin-top: 5px;
        transition: background-color 0.3s ease;
      }

      .nav-btn:hover {
        background-color: #e2e6ea;
      }

      .action-btn {
        margin-left: 10px;
        padding: 13px 20px;
        font-weight: bold;
        font-size: 15px;
        color: #000;
        background-color: #99ccff;
        border: none;
        border-radius: 5px;
        margin-bottom: 1rem;
        margin-top: 1rem;
        height: 55px;
      }

      .button-btn {
        margin-top: 10px;
        float: left;
        margin-left: 20px;
        padding: 10px 20px;
        font-weight: bold;
        font-size: 15px;
        color: #fff;
        background-color: rgb(0, 149, 255);
        border: none;
        border-radius: 5px;
      }
      .button-btns {
        margin-top: 10px;
        float: left;
        margin-left: 20px;
        padding: 10px 20px;
        font-weight: bold;
        font-size: 15px;
        color: #fff;
        background-color: rgb(255, 0, 0);
        border: none;
        border-radius: 5px;
      }

      .remove-file {
        cursor: pointer;
        margin-left: 5px;
        color: red;
      }

      .file-list {
        position: absolute;
        background-color: white;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 5px;
        z-index: 1000;
        max-height: 150px;
        overflow-y: auto;
        width: 220px;
        right: 10px;
      }
.file-input-wrapper {
  display: flex;
  align-items: center;
}


.file-dropdown {
  margin-left: 10px;
  display: inline-block;
}

.dropdown-toggle {
  cursor: pointer;
  padding: 5px 10px;
  background-color: #f0f0f0;
  border: 1px solid #ccc;
  border-radius: 4px;
}

.file-list-container {
  margin-left: 10px;
}

.file-list::-webkit-scrollbar {
  width: 8px;
  height: 0;
}

.file-list::-webkit-scrollbar-thumb {
  background-color: #888;
  border-radius: 4px;
}

.file-list::-webkit-scrollbar-track {
  background-color: #f1f1f1;
}



      .file-item {
        padding: 0 5px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid #ccc;
        margin: 2px 0;
        border-radius: 4px;
        width: 200px;
        overflow: hidden;
        height: 25px;
        border-left: 1px solid #ccc;
        border-right: 1px solid #ccc;
        margin: 0 5px;
        margin-top: 2px;
        margin-bottom: 2px;
        width: 100%;
        flex: 0 0 auto;
        margin-right: 5px;
        width: 100%;
        margin-bottom: 5px;
        white-space: nowrap;
  text-overflow: ellipsis;
      }

      .file-content {
        display: flex;
        align-items: center;
        flex-grow: 1;
        padding: 5px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        border-right: 1px solid #ccc;
      }

      .file-icon {
        margin-right: 10px;
        border-right: 1px solid #ccc;
        padding-right: 10px;
      }
      .file-name {
        flex-grow: 1;
        padding-right: 10px;
        max-width: 160px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        text-decoration: none;
      } 
      
      .remove-file-container {
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 30px;
        height: 30px;
        border-left: 1px solid #ccc;
        cursor: pointer;
      }

      .remove-file {
        font-size: 14px;
      }

      .search-input-wrapper {
        position: relative;
        align-items: center;
      }

      .search-icon {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #888;
      }

      #searchInput {
        padding-right: 30px; /* Make room for the icon */
      }
    

      .button-group {
        display: flex;
        align-items: center;
        justify-content: flex-end;
      }

      .approver-buttons {
        display: flex;
        /* margin-left: 10px; */
      }

      .approver-buttons button {
        margin-left: 5px;
        margin-right: -1.9px;
      }

      .approve {
        height: 42px;
      }

    

    
      .pending-input {
        background-color: #ddd8ab; /* Light yellow */
      }

      

      .pending-input {
        background-color: #fff9c4 !important; /* Light yellow */
      }


      /* Ensure text is visible on colored backgrounds */
      .approved-input,
      .pending-input,
      .rectification-input {
        color: #000000;
      }

      /* Style for disabled inputs */
      .approved-input:disabled {
        opacity: 0.7;
      }
      .sticky-navbar-container {
        position: sticky;
        top: 0;
        z-index: 1000;
        background-color: #f0f0f0;
        padding-bottom: 10px;
      }

      .scrollable-content {
        overflow-y: auto;
        height: calc(
          100vh - 100px
        ); /* Adjust this value based on your navbar height */
      }

      .container {
        display: flex;
        flex-direction: column;
        height: 100vh;
      }

      /* Ensure the fleet-master-nav class doesn't override the sticky behavior */
      .fleet-master-nav {
        position: relative;
        top: auto;
      }
      .form-frozen {
  opacity: 0.7;
  pointer-events: none;
}
.form-frozen {
  opacity: 0.7;
  pointer-events: none;
}

.defleet-message {
  background-color: #ffcccc;
  color: #cc0000;
  padding: 10px;
  margin-bottom: 15px;
  border: 1px solid #cc0000;
  border-radius: 4px;
}


.compose-modal {
          display: none;
          position: fixed;
          left: 50%;
          top: 50%;
          transform: translate(-50%, -50%);
          width: 600px;
          height: 500px;
          background-color: #fff;
          box-shadow: 0 1px 3px 0 rgba(60,64,67,0.302), 0 4px 8px 3px rgba(60,64,67,0.149);
          border-radius: 8px;
          z-index: 1000;
          font-family: 'Roboto', Arial, sans-serif;
          resize: both;
          overflow: auto;
        }
        
        .compose-header {
          background-color: #404040;
          color: #fff;
          padding: 10px 15px;
          font-size: 14px;
          border-radius: 8px 8px 0 0;
          display: flex;
          justify-content: space-between;
          align-items: center;
          cursor: move;
        }
        
        .compose-actions button {
          background: none;
          border: none;
          color: #fff;
          font-size: 18px;
          cursor: pointer;
          margin-left: 10px;
        }
        
        .compose-body {
          padding: 10px 15px;
          height: calc(100% - 100px);
          display: flex;
          flex-direction: column;
        }
        
        .compose-body input,
        .compose-body textarea {
          border: none;
          border-bottom: 1px solid #f1f3f4;
          padding: 10px 0;
          margin-bottom: 10px;
          font-size: 14px;
          font-family: inherit;
        }
        
        .compose-body textarea {
          flex-grow: 1;
          resize: none;
        }
        
        .compose-body input:focus,
        .compose-body textarea:focus {
          outline: none;
          border-bottom: 2px solid #1a73e8;
        }
        
        .compose-tools {
          display: flex;
          padding: 10px 0;
        }
        
        .tool-btn {
          background: none;
          border: none;
          color: #5f6368;
          font-size: 20px;
          cursor: pointer;
          margin-right: 15px;
          padding: 5px;
          border-radius: 50%;
        }
        
        .tool-btn:hover {
          background-color: #f1f3f4;
        }
        
        .compose-footer {
          padding: 10px 15px;
          background-color: #f2f2f2;
          display: flex;
          align-items: center;
        }
        
        #sendEmail {
          background-color: #1a73e8;
          color: white;
          border: none;
          padding: 8px 24px;
          font-size: 14px;
          font-weight: 500;
          border-radius: 4px;
          cursor: pointer;
        }
        
        #sendEmail:hover {
          background-color: #185abc;
        }
        
        .spinner {
          border: 2px solid #f3f3f3;
          border-top: 2px solid #1a73e8;
          border-radius: 50%;
          width: 20px;
          height: 20px;
          animation: spin 1s linear infinite;
          display: inline-block;
          margin-left: 10px;
        }
        
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }

        .vehicle-info-table {
          width: 100%;
          border-collapse: collapse;
          margin-bottom: 20px;
        }
      
        .vehicle-info-table th,
        .vehicle-info-table td {
          border: 1px solid #ddd;
          padding: 8px;
          text-align: left;
        }
      
        .vehicle-info-table th {
          background-color: #f2f2f2;
          font-weight: bold;
        }
      
        .vehicle-info-table tr:nth-child(even) {
          background-color: #f9f9f9;
        }
      
        .vehicle-info-table tr:hover {
          background-color: #f5f5f5;
      }

      .file-toggle-icon {
  cursor: pointer;
  padding: 5px;
  background-color: #f0f0f0;
  border: 1px solid #ccc;
  border-radius: 4px;
  margin-top: 5px;
  display: inline-block;
}

      .traffic-search-results-container {
        position: absolute;
        background-color: white;
        border: 1px solid #ccc;
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        width: 100%; /* Ensure it's wide enough */
        min-width: 300px; /* Set a minimum width */
      }
      
      
      .traffic-search-results-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 15px;
        background-color: #99ccff;
        border-bottom: 1px solid #ccc;
        position: sticky;
        top: 0;
        z-index: 2;
        color: black;
        height: 35px;
      }
      
      .traffic-search-results {
        width: 100%;
        border-collapse: collapse;
      }
      
      .traffic-search-results th, .traffic-search-results td {
        padding: 8px;
        border: 1px solid #ddd;
      }
      
      .traffic-search-results tr:hover {
        background-color: #f5f5f5;
        cursor: pointer;
      }
      
      #globalTrafficSearchResults {
        position: fixed;
        top: 17%;
        left: 36%;
        transform: translateX(-50%);
        background-color: white;
        border: 1px solid #ccc;
        max-height: 550px;
        overflow-y: auto;
        z-index: 1000;
        width: 80%;
        max-width: 1000px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      
      #globalTrafficSearchResults .traffic-search-results-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 15px;
        background-color: #99ccff;
        border-bottom: 1px solid #ccc;
      }
      
      #globalTrafficSearchResults .traffic-search-results {
        width: 100%;
        border-collapse: collapse;
      }
      
      #globalTrafficSearchResults td, #globalTrafficSearchResults th {
        padding: 8px;
        border: 1px solid #ddd;
      }
      
      #globalTrafficSearchResults tr:hover {
        background-color: #f5f5f5;
        cursor: pointer;
      }
      
      #globalTrafficSearchResults .traffic-close-icon {
        cursor: pointer;
        font-size: 1.2em;
      }
      .read-only-field {
        background-color: #f0f0f0;
        cursor: not-allowed;
      }
      
      



      .email-sending-popup {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }
    
    .email-sending-content {
        background-color: white;
        padding: 20px;
        border-radius: 5px;
        text-align: center;
    }
    
    .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .success-icon, .error-icon {
        width: 40px;
        height: 40px;
        margin: 0 auto 10px;
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
    }
    
    .success-icon {
        background-image: url('path/to/success-icon.svg');
    }
    
    .error-icon {
        background-image: url('path/to/error-icon.svg');
    }
    
      
      
 
    .insurance-search-results-container {
      position: absolute;
      background-color: white;
      border: 1px solid #ccc;
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      width: 100%;
      min-width: 300px;
    }
    
    .insurance-search-results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
      background-color: #99ccff;
      border-bottom: 1px solid #ccc;
      position: sticky;
      top: 0;
      z-index: 2;
      color: black;
      height: 35px;
    }
    
    .insurance-search-results {
      width: 100%;
      border-collapse: collapse;
    }
    
    .insurance-search-results th, .insurance-search-results td {
      padding: 8px;
      border: 1px solid #ddd;
    }
    
    .insurance-search-results tr:hover {
      background-color: #f5f5f5;
      cursor: pointer;
    }
    
    #globalInsuranceSearchResults {
      position: fixed;
      top: 17%;
      left: 36%;
      transform: translateX(-50%);
      background-color: white;
      border: 1px solid #ccc;
      max-height: 550px;
      overflow-y: auto;
      z-index: 1000;
      width: 80%;
      max-width: 1000px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    #globalInsuranceSearchResults .insurance-search-results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
      background-color: #99ccff;
      border-bottom: 1px solid #ccc;
    }
    
    #globalInsuranceSearchResults .insurance-search-results {
      width: 100%;
      border-collapse: collapse;
    }
    
    #globalInsuranceSearchResults td, #globalInsuranceSearchResults th {
      padding: 8px;
      border: 1px solid #ddd;
    }
    
    #globalInsuranceSearchResults tr:hover {
      background-color: #f5f5f5;
      cursor: pointer;
    }
    
    #globalInsuranceSearchResults .insurance-close-icon {
      cursor: pointer;
      font-size: 1.2em;
    }
    
    .read-only-field {
      background-color: #f0f0f0;
      cursor: not-allowed;
    }    


    input[type="file"]:disabled {
      background-color: #e9ecef !important;
      cursor: not-allowed !important;
      opacity: 0.7;
  }
  

      
      

      
      
</style>
   
  </head>

  <body>
    <div class="container">
      <div class="sticky-navbar-container">
        <h1
          style="
            padding-bottom: 12px;
            margin-bottom: 5px;
            font-size: 20px;
            font-weight: bold;
          "
        >
          Commercial Master
        </h1>
        <nav class="navbar navbar-expand-lg navbar-dark fleet-master-nav">
          <div class="container-fluid">
            <button
              class="navbar-toggler"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#fleetMasterNavbar"
              aria-controls="fleetMasterNavbar"
              aria-expanded="false"
              aria-label="Toggle navigation"
            >
              <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="fleetMasterNavbar">
              <ul class="navbar-nav w-100">
                <div class="d-flex justify-content-between w-100">
                  <div class="d-flex">
                    <li class="nav-item">
                      <a
                        class="nav-link active"
                        aria-current="page"
                        href="#"
                        id="newForm"
                      >
                        <button class="btn nav-btn" id="newForm">
                          <box-icon
                            name="revision"
                            color="black"
                            class="add-icon"
                          ></box-icon>
                          <span
                            style="
                              font-size: 15px;
                              color: black;
                              margin-left: 5px;
                            "
                            >Refresh</span
                          >
                        </button>
                      </a>
                    </li>
                    <li class="nav-item">
                      <a
                        class="nav-link active"
                        aria-current="page"
                        href="#"
                        id="editButton"
                      >
                        <button class="btn nav-btn" id="editButton">
                          <box-icon
                            type="solid"
                            name="edit-alt"
                            color="orange"
                            class="add-icon"
                          ></box-icon>

                          <span
                            style="
                              font-size: 15px;
                              color: black;
                              margin-left: 5px;
                            "
                            >Edit</span
                          >
                        </button>
                      </a>
                    </li>

                    <li class="nav-item">
                      <a
                        class="nav-link active"
                        aria-current="page"
                        href="#"
                        id="addRow"
                      >
                        <button class="btn nav-btn" id="addinsuranceRow">
                          <box-icon
                            name="list-plus"
                            color="green"
                            class="add-icon"
                          ></box-icon>
                          <span
                            style="
                              font-size: 15px;
                              color: black;
                              margin-left: 5px;
                            "
                            >Add Row</span
                          >
                        </button>
                      </a>
                    </li>
                    <li class="nav-item">
                      <a
                        class="nav-link active"
                        aria-current="page"
                        href="#"
                        id="removeRow"
                      >
                        <button class="btn nav-btn" id="removeinsuranceRow">
                          <box-icon
                            name="list-minus"
                            color="red"
                            class="del-icon"
                          ></box-icon>
                          <span
                            style="
                              font-size: 15px;
                              color: black;
                              margin-left: 5px;
                            "
                            >Del Row</span
                          >
                        </button>
                      </a>
                    </li>
                  </div>
                  <div>
                    <li class="nav-item">
                      <a
                        class="nav-link active"
                        aria-current="page"
                        href="#"
                        id="saveform"
                      >
                        <button type="button" id="saveform" class="btn nav-btn">
                          <box-icon
                            name="save"
                            color="black"
                            class="del-icon"
                          ></box-icon>
                          <span
                            style="
                              font-size: 15px;
                              color: black;
                              margin-left: 5px;
                            "
                            >Save</span
                          >
                        </button>
                      </a>

                      <a
                        class="nav-link active"
                        aria-current="page"
                        href="#"
                        id="submitForm"
                      >
                        <button class="btn nav-btn" id="submitForm">
                          <box-icon
                            name="save"
                            color="black"
                            class="del-icon"
                          ></box-icon>
                          <span
                            style="
                              font-size: 15px;
                              color: black;
                              margin-left: 5px;
                            "
                            >Submit</span
                          >
                        </button>
                      </a>
                      <div id="composeModal" class="compose-modal">
                        <div class="compose-header" id="composeHeader">
                          <span>New Message</span>
                          <div class="compose-actions">
                            <button class="close">×</button>
                          </div>
                        </div>
                        <div class="compose-body">
                          <input type="text" id="to" placeholder="To">
                          <input type="text" id="cc" placeholder="Cc">
                          <input type="text" id="bcc" placeholder="Bcc">
                          <input type="text" id="subject" placeholder="Subject">
                          <textarea id="message" rows="10"></textarea>
                         
                        </div>
                        <div class="compose-footer">
                          <button id="sendEmail">Send</button>
                          <div id="loadingSpinner" class="spinner" style="display: none;"></div>
                        </div>
                      </div>

                      <a
                        class="nav-link active"
                        aria-current="page"
                        href="#"
                        id="cancelForm"
                      >
                        <button class="btn nav-btn" id="cancelForm">
                          <box-icon
                            name="x-circle"
                            color="red"
                            class="del-icon"
                          ></box-icon>
                          <span
                            style="
                              font-size: 15px;
                              color: black;
                              margin-left: 5px;
                            "
                            >Send for Cancellation</span
                          >
                        </button>
                      </a>
                    </li>
                  </div>
                </div>
              </ul>
            </div>
          </div>
        </nav>
      </div>
      <div class="scrollable-content">
        <h2 style="text-align: center; font-size: 25px; font-weight: bold">
          Commercial Information
        </h2>
        <form id="commercialForm" enctype="multipart/form-data">
          <div class="vehicle-info">
            <div class="left-column">
              <div class="form-group search-container">
                <label for="searchInput">Search</label>
                <div class="search-input-wrapper">
                <input type="text" id="searchInput" placeholder="Search commercial numbers..." autocomplete="off">
                  <i class="fas fa-search search-icon"></i>
                </div>
                <div class="search-results-container">
                  <div class="search-results-header">
                    <span>Search Results</span>
                    <span class="close-icon"><i class="fas fa-times"></i></span>
                  </div>
                  <table class="search-results">
                    <thead>
                      <tr>
                        <th class="table-heading">Header ID</th>
                        <th class="table-heading">Commercial Control Number</th>
                        <th class="table-heading">Date</th>
                        <th class="table-heading">Plate No</th>
                        <th class="table-heading">Category</th>
                        <th class="table-heading">issued Authority</th>
                        <th class="table-heading">Vehicle Type</th>
                        <th class="table-heading">Color</th>
                        <th class="table-heading">Status</th>
                       
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>

                 
              </div>

              <div class="form-group">
                <label>Company Name</label>
                <select id="companyName" name="COMPANY NAME_LOOKUP_NAME" style="background-color: #ffff76; color: black">
                  <option value=""></option>
                </select>
              </div>
              <div class="form-group">
                <label>Commercial Control No.</label>
                <input type="text" name="COMM_CONTROL_NO" disabled />
              </div>
              <input type="hidden" name="HEADER_ID" id="HEADER_ID" />

              <div class="form-group">
                <label> Date</label>
              <input type="date" name="COMM_PLATE_DATE" id="commercialCreationDate" />
              </div>
              <div class="form-group">
                <label>Plate No.</label>
                <input type="text" name="COMM_PLATE_NO" style="background-color: #ffff76; color: black"/>
              </div>
              <div class="form-group">
                <label>Category</label>
                <select id="Category" name="FLEET CATEGORY_LOOKUP_NAME" style="background-color: #ffff76; color: black">
                  <option value=""></option>
                </select>
              </div>

              <div class="form-group">
                <label>Issued Authority</label>
              <select id="IssuedAuthority" name="ISSUING AUTHORITY_LOOKUP_NAME" style="background-color: #ffff76; color: black">
                <option value=""></option>
              </select>

              </div>
              <div class="form-group">
                <label>Vehicle Type</label>
                <select id="VehicleType" name="VEHICLE TYPE_LOOKUP_NAME" style="background-color: #ffff76; color: black">
                  <option value=""></option>
                </select>
              </div>
              <div class="form-group">
                <label>Color</label>
                <select id="color" name="COLOR_LOOKUP_NAME" style="background-color: #ffff76; color: black">
                  <option value=""></option>
                </select>
              </div>
              
             
              
            </div>
            

            <div class="right-column">
              <div class="form-group">
                <label>Status</label>
                <input type="text" name="STATUS" disabled />
              </div>
              <div class="comments-section">
                <label>Comments</label>
                <textarea name="COMMENTS"></textarea>
              </div>

               
              <button class="action-btn" type="button" onclick="navigateToActionHistory()">
                <i class="fas fa-history" style="margin-right: 8px;color: #000;"></i>Action
                History
                </button>
              <button type="button" class="attachment-btn" onclick="navigateToAllAttachments()">
                <i class="fa-solid fa-paperclip" style="margin-right: 8px;color: #000;"></i>
                  Record All Attachments
                </button>
            
            </div>
          </div>
          <input type="hidden" name="isNewSubmission" value="true" id="isNewSubmission">

          <div class="tab-container">
            <div class="tabs">
              <div class="tab active" data-tab="insurance">
                Insurance Information
              </div>
              <div class="tab" data-tab="registration">
                Registration Information
              </div>
              <div class="tab" data-tab="roadtoll">Road Toll Information</div>
              <div class="tab" data-tab="allocation">
                Fleet Allocation/Custodian
              </div>
            </div>
            <div id="globalInsuranceSearchResults" class="global-insurance-search-results" style="display: none;">
              <div class="insurance-search-results-header">
                <span>Insurance File Search Results</span>
                <span class="insurance-close-icon">&times;</span>
              </div>
              <table class="insurance-search-results">
                <thead>
                  <tr>
                    <th>Insurance Company</th>
                    <th>Policy No</th>
                    <th>Policy Date</th>
                    <th>Policy Expiry Date</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div id="insurance" class="tab-content active">
              <div class="table-container">
                <table id="insuranceTable">
                  <thead>
                    <tr>
                      <th>Insurance Company</th>
                      <th>Policy No.</th>
                      <th>Policy Start Date</th>
                      <th>Policy Expiry Date</th>
                      <th>Vehicle Insurance Start Date</th>
                      <th>Vehicle Insurance Expiry Date</th>
                      <th>Current Status-Motor Insurance</th>
                      <th>Attachments</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>
                        <input type="text" class="form-control insurance-search-input" name="INSURANCE_COMPANY" required/>
                        <div class="traffic-search-wrapper">
                        <div class="insurance-search-results-container" style="display: none;">
                          <div class="insurance-search-results-header">
                            <span>Insurance File Search Results</span>
                            <span class="insurance-close-icon">&times;</span>
                          </div>
                          <table class="insurance-search-results">
                            <thead>
                              <tr>
                                <th>Insurance Company</th>
                                <th>Policy No</th>
                                <th>Policy Date</th>
                                <th>Policy Expiry Date</th>
                                <th>Vehicle Insurance Start Date</th>
                              </tr>
                            </thead>
                            <tbody></tbody>
                          </table>
                        </div>
                      </div>
                      </td>
                          <td><input type="text" class="form-control" name="POLICY_NO" required/></td>
                          <td><input type="date" class="form-control" name="POLICY_DATE" required/></td>
                          <td><input type="date" class="form-control" name="POLICY_EXPIRY_DATE" required/></td>
                          <td><input type="date" class="form-control" name="PLTS_INS_START_DATE" /></td>
                          <td><input type="date" class="form-control" name="PLTS_INS_EXPIRY_DATE" /></td>
                          <td><select class="form-control" name="CURRENT STATUS_LOOKUP_NAME"><option value=""></option></select></td>
                        <td>
                      <div class="file-input-wrapper">
                        <input type="file" class="form-control" name="InsurancePolicAattachment" multiple />
                        <div class="file-dropdown">
                          <button class="file-dropdown-btn">Files: <span class="file-count">0</span></button>
                          <div class="file-dropdown-content"></div>
                        </div>
                      </div>
                    </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            <div id="globalTrafficSearchResults" class="global-traffic-search-results" style="display: none;">
              <div class="traffic-search-results-header">
                <span>Traffic File Search Results</span>
                <span class="traffic-close-icon">&times;</span>
              </div>
              <table class="traffic-search-results">
                <thead>
                  <tr>
                    <th>Traffic File No</th>
                    <th>Company Name</th>
                    <th>Trade License No</th>
                    <th>Emirates</th>
                    <th>Federal Traffic File No</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            

            <div id="registration" class="tab-content">
              <div class="table-container">
                <table id="registrationTable">
                  <thead>
                    <tr>
                      <th>Emirates Traffic File No.</th>
                      <th>Registered Emirates</th>
                      <th>Federal Traffic File No.</th>
                      <th>Reg. Company Name</th>
                      <th>Trade License No.</th>
                      <th>Reg. No. 1</th>
                      <th>Reg. No. 2</th>
                      <th>Reg. Date</th>
                      <th>Reg. Expiry Date</th>
                      <th>Current Status-Registration</th>
                      <th>Attachments</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>
                        <input type="text" class="form-control traffic-search-input" name="EMIRATES_TRF_FILE_NO" />
                        
                        <div class="traffic-search-wrapper">
                        <div class="traffic-search-results-container" style="display: none;">
                          <div class="traffic-search-results-header">
                            <span>Traffic File Search Results</span>
                            <span class="traffic-close-icon">&times;</span>
                          </div>
                          <table class="traffic-search-results">
                            <thead>
                              <tr>
                                <th>Traffic File No</th>
                                <th>Company Name</th>
                                <th>Trade License No</th>
                                <th>Emirates</th>
                                <th>Federal Traffic File No</th>
                              </tr>
                            </thead>
                            <tbody></tbody>
                          </table>
                        </div>
                      </td>
                     <td><input type="text" class="form-control" name="REGISTERED_EMIRATES" /></td>
                      <td><input type="text" class="form-control" name="FEDERAL_TRF_FILE_NO" /></td>
                      <td><input type="text" class="form-control" name="REG_COMPANY_NAME" /></td>
                      <td><input type="text" class="form-control" name="TRADE_LICENSE_NO" /></td>
                      <td><input type="text" class="form-control" name="REGISTRATION_NO1" /></td>
                      <td><input type="text" class="form-control" name="REGISTRATION_NO" /></td>
                      <td><input type="date" class="form-control" name="REGISTRATION_DATE" /></td>
                      <td><input type="date" class="form-control" name="REG_EXPIRY_DATE" /></td>
                      <td><select class="form-control" name="CURRENT STATUS_LOOKUP_NAME"><option value=""></option></select></td>
                      <td><input type="file" class="form-control" name="RegCardAttachment"/></td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            

           

            <div id="roadtoll" class="tab-content">
              <div class="table-container">
                <table id="roadtollTable">
                  <thead>
                    <tr>
                      <th>Emirates</th>
                      <th>Toll Type</th>
                      <th>Account No.-salik</th>
                      <th>Tag No.-salik</th>
                      <th>Activation Date -Salik</th>
                      <th>Activation End Date -Salik</th>
                      <th>Current Status Salik</th>

                      <th>Attachments</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td><input type="text" class="form-control" /></td>
                      <td><input type="text" class="form-control" /></td>
                      <td><input type="number" class="form-control" /></td>
                      <td><input type="number" class="form-control" /></td>
                      <td><input type="date" class="form-control" /></td>
                      
                      <td><input type="date" class="form-control" /></td>
                      <td><input type="text" class="form-control" /></td>

                      <td><input type="file" class="form-control" /></td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
           
           

    
            <div id="allocation" class="tab-content">
              <div class="table-container">
                <table id="allocationTable">
                  <thead>
                    <tr>
                      <th>Company Name</th>
                      <th>Division/Department</th>
                      <th>Operating Location/Allication</th>
                      <th>Operating Emirates</th>
                      <th>Application/Usage</th>
                      <th>Allocation Date.</th>
                      <th>Allocation End Date.</th>
                      <th>Attachments</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td><input type="text" class="form-control" /></td>
                      <td><input type="text" class="form-control" /></td>
                      <td><input type="text" class="form-control" /></td>
                      <td><input type="text" class="form-control" /></td>
                      <td><input type="text" class="form-control" /></td>
                      <td><input type="date" class="form-control" /></td>
                      
                      <td><input type="date" class="form-control" /></td>
                      <td><input type="file" class="form-control" /></td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script id="user_roles" type="application/json">
      { "is_approver": {{ request.session.is_approver|yesno:"true,false" }} }
    </script>
    <script>
              
        function showLoadingIndicator() {
          const loadingOverlay = document.createElement('div');
          loadingOverlay.id = 'loadingOverlay';
          loadingOverlay.style.position = 'fixed';
          loadingOverlay.style.top = '0';
          loadingOverlay.style.left = '0';
          loadingOverlay.style.width = '100%';
          loadingOverlay.style.height = '100%';
          loadingOverlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
          loadingOverlay.style.display = 'flex';
          loadingOverlay.style.justifyContent = 'center';
          loadingOverlay.style.alignItems = 'center';
          loadingOverlay.style.zIndex = '9999';
      
          const spinner = document.createElement('div');
          spinner.className = 'spinner';
          spinner.style.width = '50px';
          spinner.style.height = '50px';
          spinner.style.border = '3px solid #f3f3f3';
          spinner.style.borderTop = '3px solid #3498db';
          spinner.style.borderRadius = '50%';
          spinner.style.animation = 'spin 1s linear infinite';
      
          loadingOverlay.appendChild(spinner);
          document.body.appendChild(loadingOverlay);
      }
      
      function hideLoadingIndicator() {
          const loadingOverlay = document.getElementById('loadingOverlay');
          if (loadingOverlay) {
              loadingOverlay.remove();
          }
      }
      
      // Add this CSS to your stylesheet or in a <style> tag in your HTML
      const style = document.createElement('style');
      style.textContent = `
          @keyframes spin {
              0% { transform: rotate(0deg); }
              100% { transform: rotate(360deg); }
          }
      `;
      document.head.appendChild(style);
           
      
            document.addEventListener('DOMContentLoaded', function() {
              const commercialCreationDateInput = document.getElementById('commercialCreationDate');
                    // Set today's date as the default value
                const today = new Date().toISOString().split('T')[0];
                commercialCreationDateInput.value = today;
                document.getElementById('commercialForm').addEventListener('submit', function(event) {
                  if (!commercialCreationDateInput.value) {
                    commercialCreationDateInput.value = today;
                  }
                });
                
            });
    
              document.addEventListener('DOMContentLoaded', function() {
                const urlParams = new URLSearchParams(window.location.search);
                const commercialNumber = urlParams.get('commercial_number');
                const fromApprover = urlParams.get('from_approver');
    
              if (commercialNumber && fromApprover === 'true') {
                populateFormFields(commercialNumber,true);
                      }
              });
              window.addEventListener('unhandledrejection', function(event) {
                console.error('Unhandled promise rejection:', event.reason);
              });
              async function handleRevert() {
                console.log("handleRevert function called");

                const commercialControlNumber = document.querySelector('[name="HEADER_ID"]').value;
                console.log("Commercial Control Number:", commercialControlNumber);
                
                if (confirm("Are you sure you want to revert this request?")) {
                  try {
                    console.log("Sending revert request...");
                    const response = await fetch(`http://127.0.0.1:8000/api/revert-commercial-data/${commercialControlNumber}`, {
                      method: 'GET',
                      headers: {
                        'Content-Type': 'application/json',
                      },
                    });

                    if (!response.ok) {
                      throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    console.log("Revert response:", result);
                    alert(result.message);
                    window.location.reload();
                    console.log("Navigating to approver dashboard...");
                    window.location.href = '/ALY_GTD/approver_dashboard/';
                  } catch (error) {
                    console.error('Error:', error);
                    alert(`Failed to revert: ${error.message}`);
                  }
                } else {
                  console.log("Revert cancelled by user");
                }
              }
            // Add this function to clear any cached data
              function clearCachedData() {
                localStorage.removeItem('currentCommercialControlNumber');
                localStorage.removeItem('currentCommercialStatus');
              }
    
                //approver handlings
                document.addEventListener("DOMContentLoaded", function () {
                  setupDropdowns();
                  hideCancelButton();
                });
    
                function afterPopulateForm() {
                  disableAllFields();
                  showEditButton();
                  updateEditButtonState(document.querySelector('[name="STATUS"]').value);
                  const status = document.querySelector('[name="STATUS"]').value;
                  if (status && status.toLowerCase() !== 'draft') {
                    document.querySelector('#cancelForm').style.display = 'block';
                  } else {
                      hideCancelButton();
                    }
                }
    
                
    
    
                document.addEventListener('DOMContentLoaded', function() {
                  const urlParams = new URLSearchParams(window.location.search);
                  const fromApprover = urlParams.get('from_approver') === 'true';
                  const isApprover = JSON.parse(document.getElementById('user_roles').textContent).is_approver;
                  const commercialControlNumber = document.querySelector('[name="COMM_CONTROL_NO"]').value;
                  sessionStorage.setItem('originPage', fromApprover ? 'approver' : 'non-approver');
                  if (fromApprover) {
                    console.log("This is an Approver Page");
                  } else {
                    console.log("This is a Non-Approver Page");
                  }
                  if (fromApprover) {
                      makeFieldsReadOnly(true);
                      hideRegularButtons();
                      if (isApprover) {
                          showApproverButtons();
                          document.getElementById('rectificationBtn').addEventListener('click', function() {
                            const comment = document.querySelector('textarea[name="COMMENTS"]').value;
                            showLoadingIndicator();
                            confirmAndSubmit('Return for Correction', true, comment);
                        });
    
                        document.getElementById('approveBtn').addEventListener('click', function() {
                          const comment = document.querySelector('textarea[name="COMMENTS"]').value;
                          showLoadingIndicator();
                            confirmAndSubmit('Approved', true, comment);
                        });
    
                       
                        document.getElementById('defleetBtn').addEventListener('click', function() {
                          const comment = document.querySelector('textarea[name="COMMENTS"]').value;
                          showLoadingIndicator();
                            confirmAndSubmit('Defleet', true, comment);
                        });
                      }else {
                      // Hide submit button for non-approvers
                      document.getElementById('submitForm').style.display = 'none';
                  }
                      document.getElementById('submitForm').disabled = true;
                  } else {
                      makeFieldsReadOnly(false);
                      document.getElementById('submitForm').addEventListener('click', function() {
                           showComposeModal(commercialControlNumber);
                      });
                  }
                });
                
    
                function hideRegularButtons() {
                  document.getElementById('newForm').style.display = 'none';
                  document.getElementById('addRow').style.display = 'none';
                  document.getElementById('removeRow').style.display = 'none';
                }
    
                
                function showApproverButtons() {
               
                  const approverButtons = `
                      <div class="approver-buttons">
                          <button class="btn nav-btn approve" id="rectificationBtn">
                              <box-icon name='file-blank' color="blue" class="approver-icon"></box-icon>
                              <span style="font-size: 15px; color: black; margin-left: 5px;">Rectification</span>
                          </button>
                          <button class="btn nav-btn approve" id="approveBtn">
                              <box-icon name='check-circle' color="green" class="approver-icon"></box-icon>
                              <span style="font-size: 15px; color: black; margin-left: 5px;">Approved</span>
                          </button>
                          
                          <button class="btn nav-btn approve" id="defleetBtn">
                              <box-icon name='edit-alt' color="orange" class="approver-icon"></box-icon>
                              <span style="font-size: 15px; color: black; margin-left: 5px;">Defleet</span>
                          </button>
                          <button class="btn nav-btn approve" id="revertBtn">
                            <box-icon name='undo' color="red" class="approver-icon"></box-icon>
                            <span style="font-size: 15px; color: black; margin-left: 5px;">Revert</span>
                          </button>
                      </div>
                  `;
                  document.getElementById('submitForm').style.display = 'none'; // Hide the submit button
                  document.getElementById('submitForm').insertAdjacentHTML('afterend', approverButtons);
                  const revertBtn = document.getElementById('revertBtn');
                  if (revertBtn) {
                    console.log("Attaching event listener to revert button");
                    revertBtn.addEventListener('click', function onRevertClick(event) {
                      console.log("Revert button clicked");
                      handleRevert();
                    });
                  } else {
                    console.error("Revert button not found after adding to DOM");
                  }
                 
                }
    
                let formSubmitted = false;
    
                document.addEventListener('DOMContentLoaded', function() {
                  const rectificationBtn = document.getElementById('rectificationBtn');
                  const approveBtn = document.getElementById('approveBtn');
                  const defleetBtn = document.getElementById('defleetBtn');
                  const statusField = document.querySelector('input[name="STATUS"]');
                  //const submitButton = document.getElementById('submitForm');
    
                  

                  async function fetchEmailAddresses(lookupValue) {
                    try {
                        const response = await fetch(`http://127.0.0.1:8000/api/related-data/?lookup_value=${lookupValue}`);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        const data = await response.json();
                        
                        const toEmail = data.find(item => item.LOOKUP_CODE === 'TO' && item.ACTIVE === 'Y')?.MEANING;
                        const ccEmail = data.find(item => item.LOOKUP_CODE === 'CC' && item.ACTIVE === 'Y')?.MEANING;
                        
                        return { toEmail, ccEmail };
                    } catch (error) {
                        console.error(`Error fetching email addresses for ${lookupValue}:`, error);
                        return null;
                      }
                  }
    
    
               

                   // Function to show loading popup and handle email sending result
                   function showEmailSendingPopup(emailSendingPromise) {
                    // Create and show loading popup
                    const popup = document.createElement('div');
                    popup.className = 'email-sending-popup';
                    popup.innerHTML = `
                        <div class="email-sending-content">
                            <div class="loading-spinner"></div>
                            <p>Sending email...</p>
                        </div>
                    `;
                    document.body.appendChild(popup);

                    // Handle the email sending promise
                    emailSendingPromise
                        .then(result => {
                            updatePopupContent(popup, 'success', 'Email sent successfully!');
                        })
                        .catch(error => {
                            updatePopupContent(popup, 'error', 'Failed to send email. Please try again.');
                            console.error('Email sending error:', error);
                        })
                        .finally(() => {
                            // Remove popup after 3 seconds
                            setTimeout(() => {
                                document.body.removeChild(popup);
                            }, 3000);
                        });
                  }


                  function updatePopupContent(popup, status, message) {
                    const content = popup.querySelector('.email-sending-content');
                    content.innerHTML = `
                        <div class="${status}-icon"></div>
                        <p>${message}</p>
                    `;
                  }

           
                  document.getElementById('commercialForm').addEventListener('submit', function(event) {
                    if (formSubmitted) {
                        event.preventDefault();
                        alert('Submit successful');
                        formSubmitted = false;
                    }
                  });
                });
          
    
                function makeFieldsReadOnly(isReadOnly) {
                    const inputs = document.querySelectorAll('input:not([name="COMMENTS"]), select');
                    inputs.forEach(input => {
                        input.readOnly = isReadOnly;
                        if (input.tagName === 'SELECT') {
                            input.style.pointerEvents = isReadOnly ? 'none' : 'auto';
                        }
                    });
                }
    
                function enableCommentsAndButtons() {
                    const allInputs = document.querySelectorAll('input, select, textarea');
                    allInputs.forEach(input => {
                        input.disabled = false;
                        if (input.name !== "COMMENTS") {
                            input.readOnly = true;
                        }
                    });
    
                    const commentsField = document.querySelector('textarea[name="COMMENTS"]');
                    if (commentsField) {
                        commentsField.readOnly = false;
                        commentsField.disabled = false;
                    }
    
                  // Enable file inputs and their associated elements
                  const fileInputs = document.querySelectorAll('input[type="file"]');
                  fileInputs.forEach(fileInput => {
                      fileInput.disabled = false;
                      fileInput.readOnly = false;
    
                      // Enable the file list container if it exists
                      const fileListContainer = fileInput.nextElementSibling;
                      if (fileListContainer && fileListContainer.classList.contains('file-list')) {
                          fileListContainer.style.pointerEvents = 'auto';
                          fileListContainer.style.opacity = '1';
                      }
    
                      // Enable the remove file icons if they exist
                      const removeIcons = fileInput.closest('td').querySelectorAll('.remove-file');
                      removeIcons.forEach(icon => {
                          icon.style.pointerEvents = 'auto';
                          icon.style.opacity = '1';
                      });
                  });
    
                  // Enable submit button
                    const submitButton = document.querySelector('button#submitForm');
                    if (submitButton) {
                        submitButton.disabled = false;
                    }
    
                    const approverButtons = document.querySelectorAll('.approver-buttons button');
                    approverButtons.forEach(button => {
                        button.disabled = false;
                    });
    
                    isEditMode = true;
                }
    
               
    
                function updateSaveButtonVisibility(status) {
                  const saveButton = document.getElementById('saveform');
                  if (saveButton) {
                    saveButton.style.display = status === 'Draft' ? 'block' : 'none';
                  }
                }
                const tablesToDisable = ['insuranceTable', 'registrationTable', 'roadtollTable','allocationTable'];
    
               
    
                    //edit button handlings
    
                    let isEditMode = false;
    
                    function disableAllFields() {
                      updateEditButtonState(document.querySelector('[name="STATUS"]').value);
                      const inputs = document.querySelectorAll('input, select, textarea');
                      inputs.forEach(input => {
                        input.disabled = true;
                      });
    
                      const commentsField = document.querySelector('textarea[name="COMMENTS"]');
                      if (commentsField) {
                          commentsField.disabled = false;
                      }
    
                      const buttons = document.querySelectorAll('button');
                      buttons.forEach(button => {
                        if (button.id !== 'editButton' && button.id !== 'newForm') {
                          button.disabled = true;
                        }
                      });
    
                      const removeIcons = document.querySelectorAll('.remove-file');
                      removeIcons.forEach(icon => {
                        icon.style.pointerEvents = 'none';
                        icon.style.opacity = '0.5';
                      });
    
                      isEditMode = false;
                    }
    
    
                    
    
                    function disableEditingControls() {
                      document.getElementById('addRow').disabled = true;
                      document.getElementById('removeRow').disabled = true;
                      document.getElementById('submitForm').disabled = true;
                    }
    
                    function enableEditingControls() {
                      document.getElementById('addRow').disabled = false;
                      document.getElementById('removeRow').disabled = false;
                      document.getElementById('submitForm').disabled = false;
                    }
    
                    function showEditButton() {
                      document.getElementById('editButton').style.display = 'block';
                    }
    
                    function hideEditButton() {
                      document.getElementById('editButton').style.display = 'none';
                    }
    
    
    
                    function disableEditingControls() {
                      document.getElementById('addRow').disabled = true;
                      document.getElementById('removeRow').disabled = true;
                      document.getElementById('submitForm').disabled = true;
                    }
    
                    function enableEditingControls() {
                      document.getElementById('addRow').disabled = false;
                      document.getElementById('removeRow').disabled = false;
                      document.getElementById('submitForm').disabled = false;
                    }
    
                    function showEditButton() {
                      document.getElementById('editButton').style.display = 'block';
                    }
    
                    function hideEditButton() {
                      document.getElementById('editButton').style.display = 'none';
                    }
    
                    let isPopulatedData = false;
    
                    function enableAllFields() {
                      const inputs = document.querySelectorAll('input, select, textarea');
                      inputs.forEach(input => {
                        input.disabled = false;
                      });
    
                      const buttons = document.querySelectorAll('button');
                      buttons.forEach(button => {
                        button.disabled = false;
                      });
    
                      const removeIcons = document.querySelectorAll('.remove-file');
                      removeIcons.forEach(icon => {
                        icon.style.pointerEvents = 'auto';
                        icon.style.opacity = '1';
                      });
    
                      isEditMode = true;
                    }
    
                    function disableSpecificFields() {
    
                      const fieldsToDisable = ['COMM_CONTROL_NO', 'COMM_PLATE_DATE', 'STATUS'];
                      fieldsToDisable.forEach(fieldName => {
                        const field = document.querySelector(`[name="${fieldName}"]`);
                        if (field) {
                          field.disabled = true;
                          field.readOnly = true;
                          
                          if (fieldName === 'COMM_PLATE_DATE') {
                            field.style.pointerEvents = 'none';
                            field.style.backgroundColor = '#e9ecef'; // Light gray background to indicate it's disabled
                            
                            // Remove the calendar icon if it's added via CSS
                            field.style.backgroundImage = 'none';
                            
                            // If there's a separate calendar button, disable it
                            const calendarButton = field.nextElementSibling;
                            if (calendarButton && calendarButton.tagName === 'BUTTON') {
                              calendarButton.disabled = true;
                              calendarButton.style.display = 'none';
                            }
                          }
                          
                          console.log(`Field ${fieldName} disabled successfully`);
                        } else {
                          console.log(`Field ${fieldName} not found`);
                        }
                      });
                    }
                    document.addEventListener('DOMContentLoaded', function() {
                    const editButton = document.getElementById('editButton');
                    if (editButton) {
                      editButton.addEventListener('click', function() {
    
                        const fromApprover = new URLSearchParams(window.location.search).get('from_approver') === 'true';
                        if (fromApprover) {
                            enableCommentsAndButtons();
                        } else {
                            enableAllFields();
                           disableSpecificFields();
                        }
                        enableEditingControls();
                        this.style.display = 'none';
                      });
                    }
    
                  });
                    function navigateToActionHistory() {
                      var commercialNumberElement = document.querySelector('[name="COMM_CONTROL_NO"]');
                      var headerIdElement = document.querySelector('#HEADER_ID');
                      var commercialNumber = commercialNumberElement ? commercialNumberElement.value : '';
                      var headerId = headerIdElement ? headerIdElement.value : '';
    
                      // Store both values in sessionStorage
                      sessionStorage.setItem('commercialMasterState', JSON.stringify({
                        commercialNumber: commercialNumber,
                          headerId: headerId
                      }));
                      var originPage = sessionStorage.getItem('originPage');
        
    
                      var url = "{% url 'action_history' %}";
                      //url += "?fleet_number=" + encodeURIComponent(fleetNumber) + "&header_id=" + encodeURIComponent(headerId);
                      url += "?commercial_number=" + encodeURIComponent(commercialNumber) + "&HEADER_ID=" + encodeURIComponent(headerId) + "&from_approver=" + (originPage === 'approver');
       
                      window.location.href = url;
                    }                  
    
                    function navigateToAllAttachments() {
                     var commercialNumberElement = document.querySelector('[name="COMM_CONTROL_NO"]');
                      var headerIdElement = document.querySelector('#HEADER_ID');
                     var commercialNumber = commercialNumberElement ? commercialNumberElement.value : '';
                      var headerId = headerIdElement ? headerIdElement.value : '';
                  
                      // Store both values in sessionStorage
                      sessionStorage.setItem('commercialMasterState', JSON.stringify({
                        commercialNumber: commercialNumber,
                          headerId: headerId
                      }));
                      var originPage = sessionStorage.getItem('originPage');
                  
                      var url = "{% url 'commercial_attachment' %}";
                      url += "?commercial_number=" + encodeURIComponent(commercialNumber) + "&HEADER_ID=" + encodeURIComponent(headerId) + "&from_approver=" + (originPage === 'approver');
                  
                      window.location.href = url;
                  }                  
    
                    // Add this function to restore the state when the page loads
                    function restorecommercialMasterState() {
                      var storedState = sessionStorage.getItem('commercialMasterState');
                      if (storedState) {
                        var state = JSON.parse(storedState);
                        if (state.headerId) {
                          document.querySelector('#HEADER_ID').value = state.headerId;
                          populateFormFields(state.headerId, false);
                        } else if (state.commercialNumber) {
                          document.querySelector('[name="COMM_CONTROL_NO"]').value = state.commercialNumber;
                          populateFormFields(state.commercialNumber, true);
                        }
                        sessionStorage.removeItem('commercialMasterState');
                      }
                    }
    
    
                    function setupDropdowns() {
                      document.querySelectorAll("select").forEach((dropdown) => {
                          const lookupName = dropdown.getAttribute("name").replace('_LOOKUP_NAME', '').trim();
                          if (lookupName) {
                              dropdown.addEventListener("click", () => fetchDropdownOptions(lookupName, dropdown));
                          }
                          dropdown.addEventListener("change", function () {
                              this.setAttribute("data-selected", this.value);
                          });
                      });
                    }
    
                    async function fetchDropdownOptions(lookupName, dropdown, selectedValue) {
                        try {
                            const response = await fetch(`/api/dropdown-options/?lookup_name=${lookupName}`);
                            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                            const data = await response.json();
                            populateDropdown(dropdown, data.meanings, selectedValue);
                        } catch (error) {
                            console.error("Error fetching dropdown options:", error);
                        }
                    }
    
                    function populateDropdown(dropdown, options, selectedValue) {
                        let existingOptions = Array.from(dropdown.options).map(option => option.value);
    
                        options.forEach((option) => {
                            if (!existingOptions.includes(option)) {
                                const opt = document.createElement("option");
                                opt.value = option;
                                opt.textContent = option;
                                dropdown.appendChild(opt);
                            }
                        });
    
                        if (selectedValue) {
                            dropdown.value = selectedValue;
                        }
                    }
    
                    function setDropdownValue(dropdown, value) {
                      if (!dropdown || !dropdown.options) {
                          console.log(`Dropdown or options not available for value: ${value}`);
                          return;
                      }
                  
                      let options = Array.from(dropdown.options || []);
                      let optionExists = options.some(option => option.value === value);
                  
                      if (!optionExists && value) {
                          let newOption = new Option(value, value);
                          dropdown.add(newOption);
                      }
                  
                      if (value) {
                          dropdown.value = value;
                          dropdown.dispatchEvent(new Event('change'));
                          console.log(`Set ${dropdown.name} to ${value}`);
                      } else {
                          console.log(`No value provided for ${dropdown.name}`);
                      }
                  }
    
                      //tabs
                      function initializeTabs() {
                          document.querySelectorAll('.tab').forEach(tab => {
                              tab.addEventListener('click', () => {
                                    document.querySelectorAll('.tab, .tab-content').forEach(el => el.classList.remove('active'));
                                    tab.classList.add('active');
                                    const contentId = tab.dataset.tab;
                                    const content = document.getElementById(contentId);
                                    if (content) {
                                        content.classList.add('active');
                                    } else {
                                        console.error(`Tab content not found for id: ${contentId}`);
                                    }
                                });
                          });
                      }
                      function loadContent(page) {
                        const contentDiv = document.querySelector('.height-100');
                        fetch(page)
                            .then(response => response.text())
                            .then(html => {
                                contentDiv.innerHTML = html;
                                initializeTabs();
                            })
                            .catch(error => {
                                console.error('Error loading content:', error);
                                contentDiv.innerHTML = '<p>Error loading content.</p>';
                            });
                      }
    
    
                      initializeTabs();
                      clearForm();
    
                        //search handlings
                        const searchInput = document.getElementById('searchInput');
                        const searchResultsContainer = document.querySelector('.search-results-container');
                        const searchResults = document.querySelector('.search-results tbody');
                        const closeIcon = document.querySelector('.close-icon');
    
                        let commercialInfo = []; // Store the fetched data
    
                        searchInput.addEventListener('focus', fetchAndPopulateSearchResults);
                        searchInput.addEventListener('click', fetchAndPopulateSearchResults);
                        searchInput.addEventListener('input', fetchAndPopulateSearchResults);
                        searchInput.addEventListener('keydown', function(event) {
                          if (event.key === 'Enter') {
                            event.preventDefault();
                            const firstResult = searchResults.querySelector('tr');
                            if (firstResult) {
                              const selectedCommercialNumber = firstResult.firstElementChild.textContent;
                              searchInput.value = selectedCommercialNumber;
                              hideSearchResults();
                              populateFormFields(selectedCommercialNumber);
                            }
                          }
                        });
    
    
                        async function fetchCommercialInfo() {
                          if (commercialInfo.length === 0) {
                            const response = await fetch('http://127.0.0.1:8000/api/commercial-info');
                            if (!response.ok) {
                              throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            commercialInfo = await response.json();
                            console.log('Fetched commercial info:', commercialInfo);
                          }
                          return commercialInfo;
                        }
    
                        function filterAndDisplayResults() {
                          const searchTerm = searchInput.value.toLowerCase();
                          const filteredInfo = commercialInfo.filter(info => {
                            const searchableFields = [
                              info.HEADER_ID,
                              info.COMM_CONTROL_NO,
                              info.COMM_PLATE_DATE,
                              info.COMM_PLATE_NO,
                              info.COMM_PLATE_CATEGORY,
                              info.CP_ISSUED_AUTHORITY,
                              info.CP_VEHICLE_TYPE,
                              info.CP_COLOR,
                              info.STATUS,
                            ].map(field => (field || '').toLowerCase());
    
                            return searchableFields.some(field => field.includes(searchTerm));
                          });
    
                          console.log('Filtered info:', filteredInfo);
    
                          searchResults.innerHTML = '';
                          filteredInfo.forEach((info) => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                              <td>${info.HEADER_ID}</td>
    
                              <td>${info.COMM_CONTROL_NO}</td>
                              <td>${info.COMM_PLATE_DATE}</td>
                              <td>${info.COMM_PLATE_NO}</td>
                              <td>${info.COMM_PLATE_CATEGORY}</td>
                              <td>${info.CP_ISSUED_AUTHORITY}</td>
                              <td>${info.CP_VEHICLE_TYPE}</td>
                              <td>${info.CP_COLOR}</td>
                              <td>${info.STATUS}</td>
                            `;
    
                            tr.addEventListener('click', function (e) {
                              e.stopPropagation();
                              searchInput.value = info.COMM_CONTROL_NO;
                              hideSearchResults();
                              populateFormFields(info.COMM_CONTROL_NO);
                            });
                            searchResults.appendChild(tr);
    
                            tr.addEventListener('click', function (e) {
                              e.stopPropagation();
                              searchInput.value = info.HEADER_ID;
                              hideSearchResults();
                              populateFormFields(info.HEADER_ID, true);
                            });
                            searchResults.appendChild(tr);
                          });
    
                        }
    
    
                        function hideCancelButton() {
                          const cancelButton = document.querySelector('#cancelForm');
                          if (cancelButton) {
                              cancelButton.style.display = 'none';
                          }
                        }
    
    
    
    
                      async function fetchAndPopulateSearchResults(event) {
                        event.stopPropagation();
                        try {
                          await fetchCommercialInfo();
                          filterAndDisplayResults();
                          showSearchResults();
                        } catch (error) {
                          console.error('Error fetching commercial info:', error);
                        }
                      }

                      
    
                      function showSearchResults() {
                        searchResultsContainer.style.display = 'block';
                      }
    
                      function hideSearchResults() {
                        searchResultsContainer.style.display = 'none';
                      }
    
                      closeIcon.addEventListener('click', function(e) {
                        e.stopPropagation();
                        hideSearchResults();
                      });
    
                      document.addEventListener('click', function(event) {
                        if (!event.target.closest('.search-container')) {
                          hideSearchResults();
                        }
                      });
    
                      searchResults.addEventListener("click", function (e) {
                        if (e.target.tagName === "TD") {
                          const selectedCommercialNumber = e.target.parentElement.firstElementChild.textContent;
                          searchInput.value = selectedCommercialNumber;
                          hideSearchResults();
                          populateFormFields(selectedCommercialNumber);
                        }
                      });
    
                      searchResults.addEventListener("click", function (e) {
                        if (e.target.tagName === "LI") {
                          const selectedCommercialNumber = e.target.textContent;
                          searchInput.value = selectedCommercialNumber;
                          searchResults.style.display = "none";
                          populateFormFields(selectedCommercialNumber);
                        }
                      });
    
    
                      // Assuming populateFormFields function is defined elsewhere
                      function populateFormFields(headerId) {
                        // Implementation of populating form fields
                        console.log('Populating form fields for:', CommercialControlNumber);
                      }
    
                      function updateSaveButtonVisibility(status) {
                        const saveButton = document.getElementById('saveform');
                        if (saveButton) {
                          saveButton.style.display = status === 'Draft' ? 'block' : 'none';
                        }
                      }
    
                      function disablePopulatedFields() {
                        const inputs = document.querySelectorAll('input, select, textarea');
                        inputs.forEach(input => {
                          if (input.value !== '') {
                            input.disabled = true;
                          }
                        });
    
                        // Disable populated rows in tables
                        const tables = document.querySelectorAll('table');
                        tables.forEach(table => {
                          const rows = table.querySelectorAll('tbody tr');
                          rows.forEach(row => {
                            const inputs = row.querySelectorAll('input, select, textarea');
                            let isPopulated = false;
                            inputs.forEach(input => {
                              if (input.value !== '') {
                                isPopulated = true;
                              }
                            });
                            if (isPopulated) {
                              inputs.forEach(input => {
                                input.disabled = true;
                              });
                            }
                          });
                        });
                      }
    
                  
                        document.querySelector('#searchInput').addEventListener('change', function() {
                            const CommercialNumber = this.value;
                            if (CommercialNumber) {
                                populateFormFields(CommercialNumber);
                                // The afterPopulateForm function will handle showing/hiding the cancel button
                            } else {
                                clearForm();
                                hideCancelButton(); // Hide cancel button when clearing the form
                            }
                        });



                        
    
                        async function populateFormFields(identifier, isApproverPage = false) {
                          clearCachedData();
                          const isFromApprover = sessionStorage.getItem('fromApproverFlow') === 'true';
                      
                          try {
                              const url = `http://127.0.0.1:8000/api/commercial-master/${identifier}`;
                              const response = await fetch(url);
                      
                              if (!response.ok) {
                                  if (response.status === 404) {
                                      console.error(`Commercial master with ${isApproverPage ? 'Commercial control number' : 'header ID'} ${identifier} not found`);
                                  } else {
                                      throw new Error(`HTTP error! status: ${response.status}`);
                                  }
                              } else {
                                  const data = await response.json();
                                  console.log("Fetched Commercial data:", data);
                      
                                 // Inside populateFormFields function, within the if (isFromApprover) block
if (isFromApprover) {
  // Disable all form inputs
  document.querySelectorAll('input, select, textarea').forEach(element => {
    if (!element.classList.contains('action-history-btn') &&
        !element.classList.contains('attachment-btn')) {
      element.disabled = true;
    }
  });


  

  // Enable comments field for approver
  const commentsField = document.querySelector('textarea[name="COMMENTS"]');
  if (commentsField) {
    commentsField.disabled = false;
    commentsField.style.backgroundColor = '#ffffff';
    commentsField.style.cursor = 'text';
  }

  // Keep action history and attachment buttons enabled
  document.querySelectorAll('.action-history-btn, .attachment-btn').forEach(btn => {
    btn.disabled = false;
  });

  // Set background color for disabled fields
  document.querySelectorAll('input:disabled, select:disabled, textarea:disabled').forEach(element => {
    element.style.backgroundColor = '#ffff76';
  });
}

                                  // Continue with the rest of your existing code...
                                  updateSaveButtonVisibility(data.STATUS);
                                setTimeout(() => {
                                  setDropdownValue(document.querySelector('[name="COMPANY NAME_LOOKUP_NAME"]'), data.COMPANY_NAME);
                                  setDropdownValue(document.querySelector('[name="VEHICLE TYPE_LOOKUP_NAME"]'), data.CP_VEHICLE_TYPE);
                                  setDropdownValue(document.querySelector('[name="COLOR_LOOKUP_NAME"]'), data.CP_COLOR);
                                  setDropdownValue(document.querySelector('[name="FLEET CATEGORY_LOOKUP_NAME"]'), data.COMM_PLATE_CATEGORY);
                                  setDropdownValue(document.querySelector('[name="ISSUING AUTHORITY_LOOKUP_NAME"]'), data.CP_ISSUED_AUTHORITY);
    
                                  setDropdownValue(document.querySelector('[name="REG_COMPANY_NAME"]'), data.registration[0].REG_COMPANY_NAME);
                                  setDropdownValue(document.querySelector('[name=""]'), data.registration[0].REGISTERED_EMIRATES);
                                                    }, 100);
    
    
                                for (const [key, value] of Object.entries(data)) {
                                  if (key !== "insurances"  && key !== "registration" && key !== "roadtoll" && key !== "allocation") {
                                    const field = document.querySelector(`[name="${key}"]`);
                                    if (field && field.type !== "file") {
                                      field.value = value;
                                    }
                                  }
                                }
    
                                // Populate insurance table
                                
                                const insuranceTable = document.querySelector("#insuranceTable tbody");
                                insuranceTable.innerHTML = "";
                                const hasApprovedInsuranceRow = data.insurances.some(insurance => insurance.FLEET_PROCESS === 'Approved');
                                
                                if (Array.isArray(data.insurances)) {
                                    data.insurances.forEach((insurance) => {
                                        const row = insuranceTable.insertRow();
                                        row.dataset.process = insurance.FLEET_PROCESS;
                                
                                        let inputClass = '';
                                        if (insurance.FLEET_PROCESS === 'Approved') {
                                            inputClass = 'approved-input';
                                        } else if (insurance.FLEET_PROCESS === 'Pending for Approval') {
                                            inputClass = 'pending-input';
                                        } else if (insurance.FLEET_PROCESS === 'Return for Correction') {
                                            inputClass = 'rectification-input';
                                        }
                                
                                        const isDisabled = isFromApprover || isApproverPage || insurance.FLEET_PROCESS === 'Approved';
                                
                                        row.innerHTML = `
                                            <td>
                                                <input type="text" class="form-control insurance-search-input ${inputClass}" name="INSURANCE_COMPANY" value="${insurance.INSURANCE_COMPANY}" ${isDisabled ? 'disabled' : ''} style="background-color: ${isDisabled ? '#e9ecef' : '#ffff76'}; color: black"/>
                                                <div class="insurance-search-results-container" style="display: none;">
                                                    <div class="insurance-search-results-header">
                                                        <span>Insurance File Search Results</span>
                                                        <span class="insurance-close-icon">&times;</span>
                                                    </div>
                                                    <table class="insurance-search-results">
                                                        <thead>
                                                            <tr>
                                                                <th>Insurance Company</th>
                                                                <th>Policy No</th>
                                                                <th>Policy Date</th>
                                                                <th>Policy Expiry Date</th>
                                                                <th>Vehicle Insurance Start Date</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody></tbody>
                                                    </table>
                                                </div>
                                            </td>
                                            <td><input type="text" class="form-control ${inputClass}" name="POLICY_NO" value="${insurance.POLICY_NO}" ${isDisabled ? 'disabled' : ''} style="background-color: ${isDisabled ? '#e9ecef' : '#ffff76'}; color: black"/></td>
                                            <td><input type="date" class="form-control ${inputClass}" name="POLICY_DATE" value="${insurance.POLICY_DATE}" ${isDisabled ? 'disabled' : ''} style="background-color: ${isDisabled ? '#e9ecef' : '#ffff76'}; color: black"/></td>
                                            <td><input type="date" class="form-control ${inputClass}" name="POLICY_EXPIRY_DATE" value="${insurance.POLICY_EXPIRY_DATE}" ${isDisabled ? 'disabled' : ''} style="background-color: ${isDisabled ? '#e9ecef' : '#ffff76'}; color: black"/></td>
                                            <td><input type="date" class="form-control ${inputClass}" name="PLTS_INS_START_DATE" value="${insurance.PLTS_INS_START_DATE}" ${isDisabled ? 'disabled' : ''} style="background-color: ${isDisabled ? '#e9ecef' : '#ffff76'}; color: black"/></td>
                                            <td><input type="date" class="form-control ${inputClass}" name="PLTS_INS_EXPIRY_DATE" value="${insurance.PLTS_INS_EXPIRY_DATE}" ${isDisabled ? 'disabled' : ''} style="background-color: ${isDisabled ? '#e9ecef' : '#ffff76'}; color: black"/></td>
                                            <td><select class="form-control ${inputClass}" name="CURRENT STATUS_LOOKUP_NAME" ${isDisabled ? 'disabled' : ''} style="background-color: ${isDisabled ? '#e9ecef' : '#ffff76'}; color: black"><option value=""></option></select></td>
                                            <td><input type="file" class="form-control ${inputClass}" name="InsurancePolicAattachment" disabled style="background-color: #e9ecef; cursor: not-allowed;"/></td>

                                            <input type="hidden" name="insurance_id" value="${insurance.INS_LINE_ID}" />
                                            <input type="hidden" name="FLEET_PROCESS" value="${insurance.FLEET_PROCESS}" />
                                        `;
                                
                                        setupDropdownsForNewRow(row);
                                
                                        setTimeout(() => {
                                            setDropdownValue(row.querySelector('select[name="CURRENT STATUS_LOOKUP_NAME"]'), insurance.CUR_STAT_MOT_INS);
                                        }, 0);
                                // Inside the insurance table population code, modify the file input and dropdown section:

const fileInput = row.querySelector('input[type="file"]');
const fileListContainer = document.createElement("div");
fileListContainer.className = "file-list-container";

// Wrap the file input and dropdown in a container
const wrapper = document.createElement('div');
wrapper.className = 'file-input-wrapper';
fileInput.parentNode.insertBefore(wrapper, fileInput);
wrapper.appendChild(fileInput);
wrapper.appendChild(fileListContainer);

const fileDropdown = createFileDropdown();
fileListContainer.appendChild(fileDropdown);

// Disable both file input and dropdown if conditions are met
if (isDisabled) {
    fileInput.disabled = true;
    fileInput.style.backgroundColor = '#e9ecef';
    fileDropdown.style.pointerEvents = 'none';
    fileDropdown.style.opacity = '0.7';
    fileDropdown.querySelector('.file-list').style.backgroundColor = '#e9ecef';
}

if (insurance.InsurancePolicAattachment) {
    const fileNames = getAllFileNames(insurance.InsurancePolicAattachment, 'insurance', insurance.INS_LINE_ID);
    fileDropdown.querySelector('.file-list').innerHTML = fileNames;
}

updateFileCount(fileInput, fileDropdown);
addFileInputListeners();

                                
                                        setupInsuranceSearchFunctionality(row);
                                    });
                                }
                                
                                        
    
const registrationTable = document.querySelector("#registrationTable tbody");
registrationTable.innerHTML = "";
const hasApprovedRegistrationRow = data.registration.some(registration => registration.FLEET_PROCESS === 'Approved');

if (Array.isArray(data.registration)) {
    data.registration.forEach((registration) => {
        const row = registrationTable.insertRow();
        row.dataset.process = registration.FLEET_PROCESS;

        let inputClass = '';
        if (registration.FLEET_PROCESS === 'Approved') {
            inputClass = 'approved-input';
        } else if (registration.FLEET_PROCESS === 'Pending for Approval') {
            inputClass = 'pending-input';
        } else if (registration.FLEET_PROCESS === 'Return for Correction') {
            inputClass = 'rectification-input';
        }

        const isDisabled = isFromApprover || isApproverPage || registration.FLEET_PROCESS === 'Approved';

        row.innerHTML = `
            <td>
                <input type="text" class="form-control traffic-search-input ${inputClass}" name="EMIRATES_TRF_FILE_NO" value="${registration.EMIRATES_TRF_FILE_NO || ""}" ${isDisabled ? 'disabled' : ''} style="background-color: ${isDisabled ? '#e9ecef' : '#ffff76'}; color: black"/>
                <div class="traffic-search-results-container" style="display: none;">
                    <!-- Traffic search results container content -->
                </div>
            </td>
            <td><input type="text" class="form-control ${inputClass}" name="REGISTERED_EMIRATES" value="${registration.REGISTERED_EMIRATES || ""}" ${isDisabled ? 'disabled' : ''} style="background-color: ${isDisabled ? '#e9ecef' : '#ffff76'}; color: black"/></td>
            <td><input type="text" class="form-control ${inputClass}" name="FEDERAL_TRF_FILE_NO" value="${registration.FEDERAL_TRF_FILE_NO || ""}" ${isDisabled ? 'disabled' : ''} style="background-color: ${isDisabled ? '#e9ecef' : '#ffff76'}; color: black"/></td>
            <td><input type="text" class="form-control ${inputClass}" name="REG_COMPANY_NAME" value="${registration.REG_COMPANY_NAME || ""}" ${isDisabled ? 'disabled' : ''} style="background-color: ${isDisabled ? '#e9ecef' : '#ffff76'}; color: black"/></td>
            <td><input type="text" class="form-control ${inputClass}" name="TRADE_LICENSE_NO" value="${registration.TRADE_LICENSE_NO || ""}" ${isDisabled ? 'disabled' : ''} style="background-color: ${isDisabled ? '#e9ecef' : '#ffff76'}; color: black"/></td>
            <td><input type="text" class="form-control ${inputClass}" name="REGISTRATION_NO1" value="${registration.REGISTRATION_NO1 || ""}" ${isDisabled ? 'disabled' : ''} style="background-color: ${isDisabled ? '#e9ecef' : '#ffff76'}; color: black"/></td>
            <td><input type="text" class="form-control ${inputClass}" name="REGISTRATION_NO" value="${registration.REGISTRATION_NO || ""}" ${isDisabled ? 'disabled' : ''} style="background-color: ${isDisabled ? '#e9ecef' : '#ffff76'}; color: black"/></td>
            <td><input type="date" class="form-control ${inputClass}" name="REGISTRATION_DATE" value="${registration.REGISTRATION_DATE || ""}" ${isDisabled ? 'disabled' : ''} style="background-color: ${isDisabled ? '#e9ecef' : '#ffff76'}; color: black"/></td>
            <td><input type="date" class="form-control ${inputClass}" name="REG_EXPIRY_DATE" value="${registration.REG_EXPIRY_DATE || ""}" ${isDisabled ? 'disabled' : ''} style="background-color: ${isDisabled ? '#e9ecef' : '#ffff76'}; color: black"/></td>
            <td><select class="form-control ${inputClass}" name="CURRENT STATUS_LOOKUP_NAME" ${isDisabled ? 'disabled' : ''} style="background-color: ${isDisabled ? '#e9ecef' : '#ffff76'}; color: black"><option value=""></option></select></td>
            <td><input type="file" class="form-control ${inputClass}" name="RegCardAttachment" disabled style="background-color: #e9ecef; cursor: not-allowed;"/></td>

            <input type="hidden" name="registration_id" value="${registration.REG_LINE_ID}" />
            <input type="hidden" name="FLEET_PROCESS" value="${registration.FLEET_PROCESS}" />
        `;

    
                                    setupDropdownsForNewRow(row);
    
                                    setTimeout(() => {
                                      setDropdownValue(row.querySelector('select[name="CURRENT STATUS_LOOKUP_NAME"]'), registration.CUR_STAT_REG);
                                    }, 0);
    
                                  
                                    const fileInput = row.querySelector('input[type="file"]');
                                    const fileListContainer = document.createElement("div");
                                    fileListContainer.className = "file-list-container";
                                    
                                    // Wrap the file input and dropdown in a container
                                    const wrapper = document.createElement('div');
                                    wrapper.className = 'file-input-wrapper';
                                    fileInput.parentNode.insertBefore(wrapper, fileInput);
                                    wrapper.appendChild(fileInput);
                                    wrapper.appendChild(fileListContainer);
                                    
                                    const fileDropdown = createFileDropdown();
                                    fileListContainer.appendChild(fileDropdown);
                                    
                                    // Disable both file input and dropdown if conditions are met
                                    if (isDisabled) {
                                        fileInput.disabled = true;
                                        fileInput.style.backgroundColor = '#e9ecef';
                                        fileInput.style.cursor = 'not-allowed';
                                        fileDropdown.style.pointerEvents = 'none';
                                        fileDropdown.style.opacity = '0.7';
                                        fileDropdown.querySelector('.file-list').style.backgroundColor = '#e9ecef';
                                    }
                                    
                                    if (registration.RegCardAttachment) {
                                        const fileNames = getAllFileNames(registration.RegCardAttachment, 'registration', registration.REG_LINE_ID);
                                        fileDropdown.querySelector('.file-list').innerHTML = fileNames;
                                    }
                                    
                                    updateFileCount(fileInput, fileDropdown);
                                    addFileInputListeners();
                                    
                                    setupTrafficSearchFunctionality(row);
                                    
                                  });
                                }
    
    
                                
    

// Roadtoll Table
const roadtollTable = document.querySelector("#roadtollTable tbody");
roadtollTable.innerHTML = "";
const hasApprovedRoadtollRow = data.roadtoll.some(roadtoll => roadtoll.FLEET_PROCESS === 'Approved');

if (Array.isArray(data.roadtoll)) {
    data.roadtoll.forEach((roadtoll) => {
        const row = roadtollTable.insertRow();
        row.dataset.process = roadtoll.FLEET_PROCESS;

        let inputClass = '';
        if (roadtoll.FLEET_PROCESS === 'Approved') {
            inputClass = 'approved-input';
        } else if (roadtoll.FLEET_PROCESS === 'Pending for Approval') {
            inputClass = 'pending-input';
        } else if (roadtoll.FLEET_PROCESS === 'Return for Correction') {
            inputClass = 'rectification-input';
        }

        const isDisabled = isFromApprover || isApproverPage || roadtoll.FLEET_PROCESS === 'Approved';

        row.innerHTML = `
            <td><select class="form-control ${inputClass}" name="AE_EMIRATES_LOOKUP_NAME" ${isDisabled ? 'disabled' : ''} style="background-color: ${isDisabled ? '#e9ecef' : '#ffff76'}; color: black"><option value=""></option></select></td>
            <td><select class="form-control ${inputClass}" name="TOLL TYPE_LOOKUP_NAME" ${isDisabled ? 'disabled' : ''} style="background-color: ${isDisabled ? '#e9ecef' : '#ffff76'}; color: black"><option value=""></option></select></td>
            <td><input type="number" class="form-control ${inputClass}" name="ACCOUNT_NO" value="${roadtoll.ACCOUNT_NO || ""}" ${isDisabled ? 'disabled' : ''} style="background-color: ${isDisabled ? '#e9ecef' : '#ffff76'}; color: black"/></td>
            <td><input type="number" class="form-control ${inputClass}" name="TAG_NO" value="${roadtoll.TAG_NO || ""}" ${isDisabled ? 'disabled' : ''} style="background-color: ${isDisabled ? '#e9ecef' : '#ffff76'}; color: black"/></td>
            <td><input type="date" class="form-control ${inputClass}" name="ACTIVATION_DATE" value="${roadtoll.ACTIVATION_DATE || ""}" ${isDisabled ? 'disabled' : ''} style="background-color: ${isDisabled ? '#e9ecef' : '#ffff76'}; color: black"/></td>
            <td><input type="date" class="form-control ${inputClass}" name="ACTIVATION_END_DATE" value="${roadtoll.ACTIVATION_END_DATE || ""}" ${isDisabled ? 'disabled' : ''} style="background-color: ${isDisabled ? '#e9ecef' : '#ffff76'}; color: black"/></td>
            <td><select class="form-control ${inputClass}" name="CURRENT STATUS_LOOKUP_NAME" ${isDisabled ? 'disabled' : ''} style="background-color: ${isDisabled ? '#e9ecef' : '#ffff76'}; color: black"><option value=""></option></select></td>
            <td><input type="file" class="form-control ${inputClass}" name="RoadtollAttachments" ${isDisabled ? 'disabled' : ''}/></td>
            <input type="hidden" name="roadtoll_id" value="${roadtoll.RT_LINE_ID || ""}" />
            <input type="hidden" name="FLEET_PROCESS" value="${roadtoll.FLEET_PROCESS}" />
        `;

    
                                    setupDropdownsForNewRow(row);
    
                                    setTimeout(() => {
                                      setDropdownValue(row.querySelector('select[name="AE_EMIRATES_LOOKUP_NAME"]'), roadtoll.EMIRATES);
                                      setDropdownValue(row.querySelector('select[name="TOLL TYPE_LOOKUP_NAME"]'), roadtoll.TOLL_TYPE);
                                      setDropdownValue(row.querySelector('select[name="CURRENT STATUS_LOOKUP_NAME"]'), roadtoll.CURRENT_STATUS);
                                    }, 0);
                                    const fileInput = row.querySelector('input[type="file"]');
                                    const fileListContainer = document.createElement("div");
                                    fileListContainer.className = "file-list-container";
                                    
                                    // Wrap the file input and dropdown in a container
                                    const wrapper = document.createElement('div');
                                    wrapper.className = 'file-input-wrapper';
                                    fileInput.parentNode.insertBefore(wrapper, fileInput);
                                    wrapper.appendChild(fileInput);
                                    wrapper.appendChild(fileListContainer);
                                    
                                    const fileDropdown = createFileDropdown();
                                    fileListContainer.appendChild(fileDropdown);
                                    
                                    // Disable both file input and dropdown if conditions are met
                                    if (isDisabled) {
                                        fileInput.disabled = true;
                                        fileInput.style.backgroundColor = '#e9ecef';
                                        fileInput.style.cursor = 'not-allowed';
                                        fileDropdown.style.pointerEvents = 'none';
                                        fileDropdown.style.opacity = '0.7';
                                        fileDropdown.querySelector('.file-list').style.backgroundColor = '#e9ecef';
                                    }
                                    
                                    if (roadtoll.RoadtollAttachments) {
                                        const fileNames = getAllFileNames(roadtoll.RoadtollAttachments, 'roadtoll', roadtoll.RT_LINE_ID);
                                        fileDropdown.querySelector('.file-list').innerHTML = fileNames;
                                    }
                                    
                                    updateFileCount(fileInput, fileDropdown);
                                    addFileInputListeners();
                                    
                                  });
                                }
    
    
// Allocation Table
const allocationTable = document.querySelector("#allocationTable tbody");
allocationTable.innerHTML = "";
const hasApprovedAllocationRow = data.allocation.some(allocation => allocation.FLEET_PROCESS === 'Approved');

if (Array.isArray(data.allocation)) {
    data.allocation.forEach((allocation) => {
        const row = allocationTable.insertRow();
        row.dataset.process = allocation.FLEET_PROCESS;

        let inputClass = '';
        if (allocation.FLEET_PROCESS === 'Approved') {
            inputClass = 'approved-input';
        } else if (allocation.FLEET_PROCESS === 'Pending for Approval') {
            inputClass = 'pending-input';
        } else if (allocation.FLEET_PROCESS === 'Return for Correction') {
            inputClass = 'rectification-input';
        }

        const isDisabled = isFromApprover || isApproverPage || allocation.FLEET_PROCESS === 'Approved';

        row.innerHTML = `
            <td><select class="form-control ${inputClass}" name="COMPANY NAME_LOOKUP_NAME" ${isDisabled ? 'disabled' : ''} style="background-color: ${isDisabled ? '#e9ecef' : '#ffff76'}; color: black"><option value=""></option></select></td>
            <td><select class="form-control ${inputClass}" name="DIVISIONS_LOOKUP_NAME" ${isDisabled ? 'disabled' : ''} style="background-color: ${isDisabled ? '#e9ecef' : '#ffff76'}; color: black"><option value=""></option></select></td>
            <td><select class="form-control ${inputClass}" name="OPERATING_LOCATION_ALLOCATION_LOOKUP_NAME" ${isDisabled ? 'disabled' : ''} style="background-color: ${isDisabled ? '#e9ecef' : '#ffff76'}; color: black"><option value=""></option></select></td>
            <td><select class="form-control ${inputClass}" name="AE_EMIRATES_LOOKUP_NAME" ${isDisabled ? 'disabled' : ''} style="background-color: ${isDisabled ? '#e9ecef' : '#ffff76'}; color: black"><option value=""></option></select></td>
            <td><input type="text" class="form-control ${inputClass}" name="APPICATION_USAGE" value="${allocation.APPICATION_USAGE || ""}" ${isDisabled ? 'disabled' : ''} style="background-color: ${isDisabled ? '#e9ecef' : '#ffff76'}; color: black"/></td>
            <td><input type="date" class="form-control ${inputClass}" name="ALLOCATION_DATE" value="${allocation.ALLOCATION_DATE || ""}" ${isDisabled ? 'disabled' : ''} style="background-color: ${isDisabled ? '#e9ecef' : '#ffff76'}; color: black"/></td>
            <td><input type="date" class="form-control ${inputClass}" name="ALLOCATION_END_DATE" value="${allocation.ALLOCATION_END_DATE || ""}" ${isDisabled ? 'disabled' : ''} style="background-color: ${isDisabled ? '#e9ecef' : '#ffff76'}; color: black"/></td>
            <td><input type="file" class="form-control ${inputClass}" name="attachment" ${isDisabled ? 'disabled' : ''}/></td>
            <input type="hidden" name="allocation_id" value="${allocation.ALLOC_LINE_ID|| ""}" />
            <input type="hidden" name="FLEET_PROCESS" value="${allocation.FLEET_PROCESS}" />
        `;

    
                                    setupDropdownsForNewRow(row);
    
                                    setTimeout(() => {
                                      setDropdownValue(row.querySelector('select[name="COMPANY NAME_LOOKUP_NAME"]'), allocation.COMPANY_NAME);
                                      setDropdownValue(row.querySelector('select[name="DIVISIONS_LOOKUP_NAME"]'), allocation.DIVISION);
                                      setDropdownValue(row.querySelector('select[name="OPERATING_LOCATION_ALLOCATION_LOOKUP_NAME"]'), allocation.OPERATING_LOCATION);
                                      setDropdownValue(row.querySelector('select[name="AE_EMIRATES_LOOKUP_NAME"]'), allocation.OPERATING_EMIRATES);
                                    }, 0);
    
                                
                                    const fileInput = row.querySelector('input[type="file"]');
                                    const fileListContainer = document.createElement("div");
                                    fileListContainer.className = "file-list-container";
                                    
                                    // Wrap the file input and dropdown in a container
                                    const wrapper = document.createElement('div');
                                    wrapper.className = 'file-input-wrapper';
                                    fileInput.parentNode.insertBefore(wrapper, fileInput);
                                    wrapper.appendChild(fileInput);
                                    wrapper.appendChild(fileListContainer);
                                    
                                    const fileDropdown = createFileDropdown();
                                    fileListContainer.appendChild(fileDropdown);
                                    
                                    // Disable both file input and dropdown if conditions are met
                                    if (isDisabled) {
                                        fileInput.disabled = true;
                                        fileInput.style.backgroundColor = '#e9ecef';
                                        fileInput.style.cursor = 'not-allowed';
                                        fileDropdown.style.pointerEvents = 'none';
                                        fileDropdown.style.opacity = '0.7';
                                        fileDropdown.querySelector('.file-list').style.backgroundColor = '#e9ecef';
                                    }
                                    
                                    if (allocation.attachment) {
                                        const fileNames = getAllFileNames(allocation.attachment, 'allocation', allocation.ALLOC_LINE_ID);
                                        fileDropdown.querySelector('.file-list').innerHTML = fileNames;
                                    }
                                    
                                    updateFileCount(fileInput, fileDropdown);
                                    addFileInputListeners();
                                    
                                  });
                                }
                                
                                if (data.STATUS === 'Defleet') {
                                  freezeForm();
                                  updateEditButtonState(data.STATUS);
                                } else {
                                  setupDeleteListeners();
                                  disableAllFields();
                                  updateSaveButtonVisibility(data.STATUS);
                                  disableEditingControls();
                                  showEditButton();
                                  isPopulatedData = true;
                          
                                  const editButton = document.getElementById('editButton');
                                  if (editButton) {
                                    editButton.style.display = 'block';
                                    editButton.addEventListener('click', function(event) {
                                      if (this.disabled) {
                                        event.preventDefault();
                                        event.stopPropagation();
                                        return false;
                                      }
                                      handleEdit(data);
                                      enableEditingControls();
                                      this.style.display = 'none';
                                    });
                                  }
                          
                                  isEditMode = false;
                                  updateEditButtonState(data.STATUS);
                                  afterPopulateForm();
                                  enableCommentsField();
                                }
                              }
                            } catch (error) {
                              console.error("Error fetching commercial details:", error);
                            }
                        }
                        function enableCommentsField() {
                          const commentsField = document.querySelector('textarea[name="COMMENTS"]');
                          if (commentsField) {
                              commentsField.disabled = false;
                              commentsField.readOnly = false;
                          }
                        }
                      
                      
    
    
                        document.addEventListener('DOMContentLoaded', function() {
                          restorecommercialMasterState();
                        });
    
                        function handleEdit(data) {
                            if (data.STATUS === 'Return for Correction') {
                              handleRectificationEdit(data);
                            } else if (data.STATUS === 'Approved') {
                              handleApprovedEdit(data);
                            } else {
                              enableAllFields();
                            }
                        }
    
                        function enableNewFieldsOnly() {
                          const inputs = document.querySelectorAll('input, select, textarea');
                          inputs.forEach(input => {
                            if (input.value === '') {
                              input.disabled = false;
                            }
                          });
    
                          // Enable empty rows in tables
                          const tables = document.querySelectorAll('table');
                          tables.forEach(table => {
                            const rows = table.querySelectorAll('tbody tr');
                            rows.forEach(row => {
                              const inputs = row.querySelectorAll('input, select, textarea');
                              let isEmpty = true;
                              inputs.forEach(input => {
                                if (input.value !== '') {
                                  isEmpty = false;
                                }
                              });
                              if (isEmpty) {
                                inputs.forEach(input => {
                                  input.disabled = false;
                                });
                              }
                            });
                          });
    
                          // Enable all buttons
                          const buttons = document.querySelectorAll('button');
                          buttons.forEach(button => {
                            button.disabled = false;
                          });
                        }
    
                        function disableCommercialMasterEditing() {
                          const commercialMasterFields = document.querySelectorAll('#commercialForm input:not([name="COMM_CONTROL_NO"]), #commercialForm select');
                          commercialMasterFields.forEach(field => {
                            field.disabled = true;
                          });
                        }
    
                        function enableCommercialMasterEditing() {
                          const hasApprovedInsuranceRow = data.insurances.some(insurance => insurance.FLEET_PROCESS === 'Approved');
                          const hasApprovedRegistrationRow = data.registration.some(registration => registration.FLEET_PROCESS === 'Approved');
                          const hasApprovedRoadtollRow = data.roadtoll.some(roadtoll => roadtoll.FLEET_PROCESS === 'Approved');
                          const hasApprovedAllocationRow = data.allocation.some(allocation => allocation.FLEET_PROCESS === 'Approved');
    
                          if (hasApprovedInsuranceRow || hasApprovedRegistrationRow || hasApprovedRoadtollRow ||
                              hasApprovedAllocationRow ) {
                            disableCommercialMasterEditing();
                          } else {
                            const commercialMasterFields = document.querySelectorAll('#commercialForm input:not([name="COMM_CONTROL_NO"]), #commercialForm select');
                            commercialMasterFields.forEach(field => {
                              field.disabled = false;
                            });
                          }
                        }
    
    
                       
                        function handleApprovedEdit(data) {
                          const fleetMasterFields = [
                            'COMM_PLATE_DATE','STATUS','COMM_CONTROL_NO'
                          ];

                          // Disable all populated fields
                          const inputs = document.querySelectorAll( ' textarea');
                          inputs.forEach(input => {
                            const name = input.getAttribute('name');
                            if (name === 'COMMENTS') {
                              input.disabled = false;
                            } else if (fleetMasterFields.includes(name) || name === 'COMM_CONTROL_NO') {
                              input.disabled = true;
                              // Create a hidden input to send the value in the request
                              const hiddenInput = document.createElement('input');
                              hiddenInput.type = 'hidden';
                              hiddenInput.name = name;
                              hiddenInput.value = input.value;
                              input.parentNode.appendChild(hiddenInput);
                            } else if (input.value !== '') {
                              input.disabled = true;
                            } else {
                              input.disabled = false;
                            }
                          });

                          const fleetStatusInput = document.querySelector('[name="STATUS"]');
                          if (fleetStatusInput) {
                            // Make it appear disabled visually
                            fleetStatusInput.style.backgroundColor = '#e9ecef';
                            fleetStatusInput.style.color = '#495057';
                            fleetStatusInput.readOnly = true; // Use readOnly instead of disabled

                            // Create a hidden input for FleetStatus
                            const hiddenStatusInput = document.createElement('input');
                            hiddenStatusInput.type = 'hidden';
                            hiddenStatusInput.name = 'STATUS';
                            hiddenStatusInput.value = 'Pending for Approval'; // Always set to 'Pending' when submitting
                            fleetStatusInput.parentNode.appendChild(hiddenStatusInput);
                          }

                          // Handle table rows
                          const tables = ['insuranceTable', 'registrationTable', 'gpsTable', 'permitsTable', 'fuelTable', 'roadtollTable', 'driverTable', 'allocationTable'];
                          const disabledInsuranceFields = ['POLICY_NO', 'POLICY_DATE', 'POLICY_EXPIRY_DATE'];
                          const disabledRegistrationFields = [ 'REGISTERED_EMIRATES', 'FEDERAL_TRF_FILE_NO', 'REG_COMPANY_NAME', 'TRADE_LICENSE_NO'];

                          
                          tables.forEach(tableId => {
                            const table = document.getElementById(tableId);
                            if (table) {
                              const rows = table.querySelectorAll('tbody tr');
                              rows.forEach((row, index) => {
                                const inputs = row.querySelectorAll('input, select, textarea');
                                inputs.forEach(input => {
                                  if ((tableId === 'insuranceTable' && disabledInsuranceFields.includes(input.name)) ||
                                      (tableId === 'registrationTable' && disabledRegistrationFields.includes(input.name)) ||
                                      (tableId === 'driverTable' && disabledDriverFields.includes(input.name)) ||
                                      (tableId === 'allocationTable' && disabledAllocationFields.includes(input.name))) {
                                    input.disabled = true;
                                    const hiddenInput = document.createElement('input');
                                    hiddenInput.type = 'hidden';
                                    hiddenInput.name = input.name;
                                    hiddenInput.value = input.value;
                                    input.parentNode.appendChild(hiddenInput);
                                  } else {
                                    input.disabled = false;
                                  }
                                });
                              });

                              // Enable the last row if it's empty
                              const lastRow = rows[rows.length - 1];
                              if (lastRow) {
                                const lastRowInputs = lastRow.querySelectorAll('input, select, textarea');
                                let isLastRowEmpty = true;
                                lastRowInputs.forEach(input => {
                                  if (input.value !== '') {
                                    isLastRowEmpty = false;
                                  }
                                });
                                if (isLastRowEmpty) {
                                  lastRowInputs.forEach(input => {
                                    input.disabled = false;
                                  });
                                }
                              }
                            }
                          });

                          // Enable add row and remove row buttons
                          document.getElementById('addRow').disabled = false;
                          document.getElementById('removeRow').disabled = false;

                          isEditMode = true;
                        }
    
    
    
                        function handleRectificationEdit(data) {
                          const hasApprovedRow = ['insurances', 'registration', 'roadtoll', 'allocation'].some(
                            category => data[category].some(item => item.FLEET_PROCESS === 'Approved')
                          );
                        
                          const fieldsToAlwaysDisable =  ['COMM_CONTROL_NO', 'COMM_PLATE_DATE', 'STATUS'];
                        
                          // Handle main form fields
                          const mainFormInputs = document.querySelectorAll('#commercialForm input, #commercialForm select, #commercialForm textarea');
                          mainFormInputs.forEach(input => {
                            const name = input.getAttribute('name');
                            
                            if (fieldsToAlwaysDisable.includes(name)) {
                              input.disabled = true;
                            } else {
                              input.disabled = false;
                            }
                        
                            // Create hidden input for all fields to ensure data is sent in the request
                            const hiddenInput = document.createElement('input');
                            hiddenInput.type = 'hidden';
                            hiddenInput.name = name;
                            hiddenInput.value = input.value;
                            input.parentNode.appendChild(hiddenInput);
                          });
                        
                          // Handle FleetStatus field
                          const commercialStatusInput = document.querySelector('[name="STATUS"]');
                          if (commercialStatusInput) {
                            commercialStatusInput.style.backgroundColor = '#e9ecef';
                            commercialStatusInput.style.color = '#495057';
                            commercialStatusInput.readOnly = true;
                        
                            // Create a hidden input for FleetStatus
                            const hiddenStatusInput = document.createElement('input');
                            hiddenStatusInput.type = 'hidden';
                            hiddenStatusInput.name = 'STATUS';
                            hiddenStatusInput.value = 'Pending for Approval'; // Set to 'Pending' when submitting
                            commercialStatusInput.parentNode.appendChild(hiddenStatusInput);
                          }
                        
                          // Handle table rows
                          const tables = ['insuranceTable', 'registrationTable', 'roadtollTable', 'allocationTable'];
                          const disabledInsuranceFields = ['POLICY_NO', 'POLICY_DATE', 'POLICY_EXPIRY_DATE'];
                          const disabledRegistrationFields = ['REGISTERED_EMIRATES', 'FEDERAL_TRF_FILE_NO', 'REG_COMPANY_NAME', 'TRADE_LICENSE_NO'];

                          tables.forEach(tableId => {
                            const table = document.getElementById(tableId);
                            if (table) {
                              const rows = table.querySelectorAll('tbody tr');
                              rows.forEach((row, index) => {
                                const inputs = row.querySelectorAll('input, select, textarea');
                                inputs.forEach(input => {
                                  const name = input.getAttribute('name');
                                  if ((tableId === 'insuranceTable' && disabledInsuranceFields.includes(name)) ||
                                      (tableId === 'registrationTable' && disabledRegistrationFields.includes(name))) {
                                    input.disabled = true;
                                    const hiddenInput = document.createElement('input');
                                    hiddenInput.type = 'hidden';
                                    hiddenInput.name = name;
                                    hiddenInput.value = input.value;
                                    input.parentNode.appendChild(hiddenInput);
                                  } else {
                                    input.disabled = false;
                                  }
                                });
                                
                                const processInput = row.querySelector('input[name="FLEET_PROCESS"]');
                                const isApproved = processInput && processInput.value === 'Approved';
                                if (isApproved) {
                                  row.classList.add('approved-row');
                                } else {
                                  row.classList.remove('approved-row');
                                }
                              });
                            }
                          });
                        
                          // Enable add row and remove row buttons
                          document.getElementById('addRow').disabled = false;
                          document.getElementById('removeRow').disabled = false;
                        
                          isEditMode = true;
                        
                          const commentsField = document.querySelector('[name="COMMENTS"]');
                          if (commentsField) {
                            commentsField.addEventListener('input', function() {
                              const hiddenComments = this.parentNode.querySelector('input[type="hidden"][name="COMMENTS"]');
                              if (hiddenComments) {
                                hiddenComments.value = this.value;
                              }
                            });
                          }
                        }
    
                      function updateEditButtonState(commercialStatus) {
                          const editButton = document.getElementById('editButton');
                          const isApprover = new URLSearchParams(window.location.search).get('from_approver') === 'true';
                          const cancelButton = document.getElementById('cancelForm');
    
                          if (cancelButton) {
                            cancelButton.disabled = false;
                            cancelButton.style.pointerEvents = 'auto';
                            cancelButton.style.opacity = '1';
                            cancelButton.style.cursor = 'pointer';
                            //cancelButton.style.backgroundColor = 'white';
                            cancelButton.style.color = 'black';
          
                          }
                          if (isApprover) {
                              // For approver, always show the approver buttons
                             
                              // Enable or disable approver buttons based on fleet status
                              const approverButtons = document.querySelectorAll('.approver-buttons button');
                              approverButtons.forEach(button => {
                                  if (commercialStatus === 'Defleet') {
                                      button.disabled = true;
                                      button.style.pointerEvents = 'none';
                                      button.style.opacity = '0.5';
                                  } else {
                                      button.disabled = false;
                                      button.style.pointerEvents = 'auto';
                                      button.style.opacity = '1';
                                  }
                              });

                            enableSubmitButton();
                            enableCommentsAndButtons();
    
                            // Hide the regular edit button for approvers
                            if (editButton) {
                              editButton.style.display = 'none';
                            }
                          } else {
                            // For requestor, handle as before
                            if (editButton) {
                                if (commercialStatus === 'Pending for Approval' || commercialStatus === 'Defleet') {
                                editButton.disabled = true;
                                editButton.style.pointerEvents = 'none';
                                editButton.style.opacity = '0.5';
                                  } else {
                                      editButton.disabled = false;
                                      editButton.style.pointerEvents = 'auto';
                                      editButton.style.opacity = '1';
                                  }
                              }
                          }

                          // Always enable these buttons
                                const alwaysEnabledButtons = [
                                document.querySelector('button[onclick="navigateToActionHistory()"]'),
                                document.querySelector('button[onclick="navigateToAllAttachments()"]')
                              ];
                            
                              alwaysEnabledButtons.forEach(button => {
                                if (button) {
                                  button.disabled = false;
                                  button.style.pointerEvents = 'auto';
                                  button.style.opacity = '1';
                                }
                              });
                      } 
                        
                      async function confirmAndSubmit(action, isApprover, comment) {
                        if (confirm(`Are you sure you want to ${action} this request?`)) {
                            try {
                                const form = document.getElementById('commercialForm');
                                const formData = new FormData(form);
                                formData.append('ACTION', action);
                                formData.append('COMMENTS', comment);
                                console.log('FormData being sent:', Object.fromEntries(formData));
                                console.log('Status before submission:', formData.get('STATUS'));
  
  
                                let newStatus;
                                switch(action) {
                                    case 'Return for Correction':
                                        newStatus = 'Return for Correction';
                                        break;
                                    case 'Approved':
                                        newStatus = 'Approved';
                                        break;
                                    case 'Defleet':
                                        newStatus = 'Defleet';
                                        break;
                                    default:
                                        newStatus = 'Pending for Approval';
                                }
  
                                // Update the status field in the form
                                const statusField = document.querySelector('input[name="STATUS"]');
                                if (statusField) {
                                    statusField.value = newStatus;
                                }
  
                                formData.set('STATUS', newStatus);
                                console.log('Status after updating:', formData.get('STATUS'));
  
  
                    
                                // Ensure all fields are included and complex fields are valid JSON
                                const allInputs = form.querySelectorAll('input, select, textarea');
                                allInputs.forEach(input => {
                                    if (input.name) {
                                        let value = input.value || '[]';
                                        if (value === '[]' || value === 'null' || value === '') {
                                            value = JSON.stringify([]);
                                        }
                                        formData.set(input.name, value);
                                    }
                                });
                    
                                // Explicitly handle complex fields
                                ['insurances','registration' , 'roadtoll', 'allocation'].forEach(field => {
                                    let value = formData.get(field);
                                    if (!value || value === '[]' || value === 'null') {
                                        value = JSON.stringify([]);
                                    } else if (typeof value === 'string' && !value.startsWith('[')) {
                                        // If it's not already a JSON array, wrap it in one
                                        value = JSON.stringify([JSON.parse(value)]);
                                    }
                                    formData.set(field, value);
                                });
                    
                                console.log('FormData being sent:', Object.fromEntries(formData));
                    
                                const response = await fetch('http://127.0.0.1:8000/api/commercial-master', {
                                    method: 'POST',
                                    body: formData
                                });
                    
                                if (!response.ok) {
                                    const errorText = await response.text();
                                    throw new Error(`Server error: ${response.status} ${response.statusText}\n${errorText}`);
                                }
                    
                                const result = await response.json();
                                console.log('Form submission result:', result);
  
                                                              
                                updateStatusDisplay(newStatus);
                                if (result.message.includes('successfully')) {
                                  alert('Submit successful');
                                  // Send email after successful form submission
                                  await sendApproverActionEmail(action, isApprover, comment, formData.get('COMM_CONTROL_NO'));
                                  window.location.href = '/ALY_GTD/approver_dashboard/';
                              } else {
                                  throw new Error('Form submission failed');
                              }
                            } catch (error) {
                                console.error('Error:', error);
                                alert(`Failed to process the request: ${error.message}`);
                            } finally {
                                hideLoadingIndicator();
                            }
                        }
                      }
                      
                      function updateStatusDisplay(status) {
                        const statusField = document.querySelector('input[name="STATUS"]');
                        if (statusField) {
                            statusField.value = status;
                        }
                        const statusDisplays = document.querySelectorAll('.status-display');
                        statusDisplays.forEach(display => {
                            display.textContent = status;
                        });
                      }
                    
                     
                        async function sendApproverActionEmail(action, isApprover, comment, commercialControlNumber) {
                          try {
                              await showComposeModal(commercialControlNumber, action, isApprover, comment);
                              console.log('Email sent successfully after form submission');
                          } catch (error) {
                              console.error('Error sending email:', error);
                              alert('Form submission was successful, but there was an error sending the email.');
                          }
                        }
                      

                        {% comment %} async function confirmAndSubmit(status, isApprover) {
                          if (confirm(`Are you sure you want to ${status.toLowerCase()} this request?`)) {
                              const commercialControlNumber = document.querySelector('[name="COMM_CONTROL_NO"]').value;
                              
                              try {
                                  await showComposeModal(commercialControlNumber, status, isApprover);
                                  
                                  if (!formSubmitted) {
                                      formSubmitted = true;
                                      document.querySelector('input[name="STATUS"]').value = status;
                                      document.getElementById('submitForm').click();
                                      setTimeout(() => {
                                          window.location.href = '/ALY_GTD/approver_dashboard/';
                                      }, 100);
                                  }
                              } catch (error) {
                                  console.error('Error in confirmAndSubmit:', error);
                                  alert(`An error occurred: ${error.message}`);
                              }
                          }
                          
                          console.log('Button clicked:', status);
                      } {% endcomment %}

                    
                        
                        function getAllFileNames(fileData, modelName, instanceId) {
                          if (typeof fileData === 'string' || Array.isArray(fileData)) {
                              const files = typeof fileData === 'string' ? fileData.split(',') : fileData;
                              return files.map((file, index) => {
                                  const fileName = file.trim().split('/').pop().replace(/["'\[\]]/g, '');
                                return createFileItem(fileName, modelName, instanceId, index);
                              }).join('');
                          }
                          return '';
                        }
                      
                        function freezeForm() {
                          const form = document.getElementById('commercialForm');
                          if (!form) {
                            console.error("Form with id 'commercialForm' not found");
                            return;
                          }
                        
                          // Disable all form elements
                            const elements = form.elements;
                            for (let i = 0; i < elements.length; i++) {
                              elements[i].disabled = true;
                            }
                            const alwaysEnabledButtons = [
                            document.querySelector('button[onclick="navigateToActionHistory()"]'),
                            document.querySelector('button[onclick="navigateToAllAttachments()"]')
                          ];
                        
                          alwaysEnabledButtons.forEach(button => {
                            if (button) {
                              button.disabled = false;
                              button.style.pointerEvents = 'auto';
                              button.style.opacity = '1';
                            }
                          });
                          // Disable all buttons within the form
                          const buttons = form.querySelectorAll('button:not([onclick="navigateToActionHistory()"]):not([onclick="navigateToAllAttachments()"])');
                          buttons.forEach(button => button.disabled = true);
                          // Disable specific navbar buttons
                          const navbarButtons = ['editButton', 'addRow', 'removeRow', 'submitForm'];
                          navbarButtons.forEach(buttonId => {
                            const button = document.getElementById(buttonId);
                            if (button) {
                              button.disabled = true;
                              button.style.pointerEvents = 'none';
                              button.style.opacity = '0.5';
                            }
                          });
                        
                          // Hide the edit button if it exists
                          const editButton = document.getElementById('editButton');
                          if (editButton) {
                            editButton.style.display = 'none';
                          }
                        
                          // Add a visual indicator that the form is frozen
                          form.classList.add('form-frozen');
                        
                          // Add a message to indicate the form is frozen
                          const messageDiv = document.createElement('div');
                          messageDiv.textContent = 'This commercial has been decommissioned and cannot be edited.';
                          messageDiv.className = 'defleet-message';
                          form.insertBefore(messageDiv, form.firstChild);
                        }

                        function validateAllTables() {
                          const requiredFields = {
                            'insuranceTable': ['INSURANCE_COMPANY', 'POLICY_NO', 'POLICY_DATE', 'PLTS_INS_START_DATE', 'POLICY_EXPIRY_DATE', 'PLTS_INS_EXPIRY_DATE', 'CURRENT STATUS_LOOKUP_NAME'],
                            'registrationTable': ['EMIRATES_TRF_FILE_NO', 'REGISTRATION_NO1', 'REGISTRATION_NO', 'REGISTRATION_DATE', 'REG_EXPIRY_DATE', 'CURRENT STATUS_LOOKUP_NAME'],
                            'roadtollTable': ['AE_EMIRATES_LOOKUP_NAME', 'TOLL TYPE_LOOKUP_NAME', 'ACTIVATION_DATE', 'ACTIVATION_END_DATE', 'CURRENT STATUS_LOOKUP_NAME'],
                            'allocationTable': ['COMPANY NAME_LOOKUP_NAME', 'DIVISIONS_LOOKUP_NAME', 'OPERATING_LOCATION_ALLOCATION_LOOKUP_NAME', 'AE_EMIRATES_LOOKUP_NAME', 'ALLOCATION_DATE', 'ALLOCATION_END_DATE']
                          };
                        
                          let errorMessages = [];
                          const activeTab = document.querySelector('.tab.active').getAttribute('data-tab');
                        
                          for (const [tableId, fields] of Object.entries(requiredFields)) {
                            const table = document.getElementById(tableId);
                            if (table) {
                              const rows = table.querySelectorAll('tbody tr');
                              let tableIsValid = false;
                              let tableHasPartialData = false;
                        
                              rows.forEach(row => {
                                let rowIsValid = true;
                                let rowHasData = false;
                                fields.forEach(fieldName => {
                                  const input = row.querySelector(`[name="${fieldName}"]`);
                                  if (input && !input.value.trim()) {
                                    if (tableId === `${activeTab}Table`) {
                                      input.style.border = '2px solid red';
                                    }
                                    rowIsValid = false;
                                  } else if (input && input.value.trim()) {
                                    rowHasData = true;
                                    input.style.border = '';
                                  }
                                });
                        
                                if (rowIsValid) {
                                  tableIsValid = true;
                                }
                                if (rowHasData && !rowIsValid) {
                                  tableHasPartialData = true;
                                }
                              });
                        
                              if (!tableIsValid || (tableId === 'insuranceTable' && tableHasPartialData)) {
                                errorMessages.push(`${tableId.replace('Table', '')} is required. Please fill in all required fields.`);
                              }
                            }
                          }
                        
                          return errorMessages;
                        }
                        function validateVehicleForm() {
                          const mandatoryFields = [
                            'COMPANY NAME_LOOKUP_NAME',
                            'COMM_PLATE_NO',
                            'FLEET CATEGORY_LOOKUP_NAME',
                            'ISSUING AUTHORITY_LOOKUP_NAME',
                            'VEHICLE TYPE_LOOKUP_NAME',
                            'COLOR_LOOKUP_NAME',
                            
                          ];

                          let isValid = true;

                          mandatoryFields.forEach(fieldName => {
                            const input = document.querySelector(`[name="${fieldName}"]`);
                            if (input && !input.value.trim()) {
                              input.style.border = '2px solid red';
                              isValid = false;
                            } else if (input) {
                              input.style.border = '';
                            }
                          });

                          return isValid;
                        }
                        
                    
                        let isNewForm = false;
                        const form = document.getElementById('commercialForm');
                        const submitButton = document.getElementById('submitForm');
                        submitButton.addEventListener('click', async function (event) {
                            if (isPopulatedData && !isEditMode) {
                                alert("Please enable editing first.");
                                return;
                            }


                            const isVehicleFormValid = validateVehicleForm();
                            const allTablesErrorMessages = validateAllTables();
                        
                            const commercialControlNumber = document.querySelector('input[name="COMM_CONTROL_NO"]').value;
                            const isNewSubmission = !commercialControlNumber;
                        
                        
                           
                        
                            let errorMessages = [];

                            if (!isVehicleFormValid) {
                              errorMessages.push("Please fill in all required fields in the commercial form.");
                            }

                            if (isNewSubmission) {
                              errorMessages = errorMessages.concat(allTablesErrorMessages);
                            }

                            if (errorMessages.length > 0) {
                              alert(errorMessages.join('\n'));
                              return;
                            }
                            
                        
                            const formData = new FormData(form);

                            const commentsField = document.querySelector('textarea[name="COMMENTS"]');
                            if (commentsField) {
                                formData.append('COMMENTS', commentsField.value);
                            }
                            const statusInput = document.querySelector('input[name="STATUS"]');
                            const action = window.isRequestingCancellation ? 'Request For Cancellation' : '';


                            const commercialPlateInput = document.querySelector('input[name="COMM_PLATE_NO"]');
                            if (commercialPlateInput) {
                                formData.append('COMM_PLATE_NO', commercialPlateInput.value);
                            }
                            const fieldMappings = {
                              'COMPANY NAME_LOOKUP_NAME': 'COMPANY_NAME',
                              'FLEET CATEGORY_LOOKUP_NAME': 'COMM_PLATE_CATEGORY',
                              'ISSUING AUTHORITY_LOOKUP_NAME': 'CP_ISSUED_AUTHORITY',
                              'VEHICLE TYPE_LOOKUP_NAME': 'CP_VEHICLE_TYPE',
                              'COLOR_LOOKUP_NAME': 'CP_COLOR',
    
                          };
    
                          for (let [lookupName, mapping] of Object.entries(fieldMappings)) {
                              const select = form.querySelector(`select[name="${lookupName}"]`);
                              if (select && select.value) {
                                  if (typeof mapping === 'object' && mapping.handler) {
                                      formData.append(mapping.apiName, mapping.handler(select.value));
                                  } else {
                                      formData.append(typeof mapping === 'string' ? mapping : mapping.apiName, select.value);
                                  }
                              }
                          }
    
    
    
                          const commercialStatus = document.querySelector('input[name="STATUS"]').value;
                          console.log("CurrentCommercialStatus:", commercialStatus);
                        
                        
                            const insuranceData = [];
                            const registrationData = [];
                            const roadtollData = [];
                            const allocationData = [];
                            const fromApprover = new URLSearchParams(window.location.search).get('from_approver') === 'true';
                        
                          
                          const insuranceRows = document.querySelectorAll('#insuranceTable tbody tr');
                          insuranceRows.forEach((row, index) => {
                              const idInput = row.querySelector('input[name="insurance_id"]');
                              const insuranceCompany = row.querySelector('input[name="INSURANCE_COMPANY"]')?.value || '';
                              if (!insuranceCompany.trim()) {
                                return; // Skip this iteration if the Insurance Company is empty
                              }
                                const insuranceRecord = {
                                  INS_LINE_ID: idInput ? idInput.value : 'new',
                                  INSURANCE_COMPANY: insuranceCompany,
                                  POLICY_NO: row.querySelector('input[name="POLICY_NO"]')?.value || '',
                                  POLICY_DATE: row.querySelector('input[name="POLICY_DATE"]')?.value || '',
                                  POLICY_EXPIRY_DATE: row.querySelector('input[name="POLICY_EXPIRY_DATE"]')?.value || '',
                                  PLTS_INS_START_DATE: row.querySelector('input[name="PLTS_INS_START_DATE"]')?.value || '',
                                  PLTS_INS_EXPIRY_DATE: row.querySelector('input[name="PLTS_INS_EXPIRY_DATE"]')?.value || '',
                                  CUR_STAT_MOT_INS: row.querySelector('select[name="CURRENT STATUS_LOOKUP_NAME"]')?.value || '',
                                  FLEET_PROCESS: commercialStatus
                                };
                                const filteredinsuranceRecord = Object.fromEntries(
                                      Object.entries(insuranceRecord).filter(([key, value]) => value !== '' && value !== null)
                                  );

                                  insuranceData.push(filteredinsuranceRecord);



                               
                                console.log(`Insurance Record ${index}:`, insuranceRecord);
                        
                                const fileInput = row.querySelector('input[type="file"]');
                                if (fileInput && fileInput.files.length > 0) {
                                    for (let i = 0; i < fileInput.files.length; i++) {
                                        formData.append(`InsurancePolicAattachment_${index}`, fileInput.files[i]);
                                    }
                                }
                            });

                            
    
                            formData.append('insurances', JSON.stringify(insuranceData));
                            formData.append('is_approver', fromApprover ? 'true' : 'false');
                        
                            // Process Registration data
                            const registrationRows = document.querySelectorAll('#registrationTable tbody tr');
                            registrationRows.forEach((row, index) => {
                              const idInput = row.querySelector('input[name="registration_id"]');
                              const emiratesTrafficFileNumber = row.querySelector('input[name="EMIRATES_TRF_FILE_NO"]')?.value || '';
                              
                              // Skip empty rows
                              if (!emiratesTrafficFileNumber.trim()) {
                                return; // Skip this iteration if the EmiratesTrafficFileNumber is empty
                              }
                              const registrationRecord = {
                                REG_LINE_ID: idInput ? idInput.value : 'new',
                                EMIRATES_TRF_FILE_NO:emiratesTrafficFileNumber,
                                REGISTERED_EMIRATES: row.querySelector('input[name="REGISTERED_EMIRATES"]')?.value || '',
                                FEDERAL_TRF_FILE_NO: row.querySelector('input[name="FEDERAL_TRF_FILE_NO"]')?.value || '',
                                REG_COMPANY_NAME: row.querySelector('input[name="REG_COMPANY_NAME"]')?.value || '',
                                TRADE_LICENSE_NO: row.querySelector('input[name="TRADE_LICENSE_NO"]')?.value || '',
                                REGISTRATION_NO1: row.querySelector('input[name="REGISTRATION_NO1"]')?.value || '',
                                REGISTRATION_NO: row.querySelector('input[name="REGISTRATION_NO"]')?.value || '',
                                REGISTRATION_DATE: row.querySelector('input[name="REGISTRATION_DATE"]')?.value || '',
                                REG_EXPIRY_DATE: row.querySelector('input[name="REG_EXPIRY_DATE"]')?.value || '',
                                CUR_STAT_REG: row.querySelector('select[name="CURRENT STATUS_LOOKUP_NAME"]')?.value || '',
                                FLEET_PROCESS:commercialStatus
                              };
                              const filteredregistrationRecord = Object.fromEntries(
                                      Object.entries(registrationRecord).filter(([key, value]) => value !== '' && value !== null)
                                  );

                                  registrationData.push(filteredregistrationRecord);
    
                              const fileInput = row.querySelector('input[type="file"]');
                              if (fileInput && fileInput.files.length > 0) {
                                for (let i = 0; i < fileInput.files.length; i++) {
                                  formData.append(`RegCardAttachment_${index}`, fileInput.files[i]);
                                }
                              }
                            });
                            formData.append('registration', JSON.stringify(registrationData));
                            formData.append('is_approver', fromApprover ? 'true' : 'false');
                        
                            // Process Roadtoll data
                            const roadtollRows = document.querySelectorAll('#roadtollTable tbody tr');
                            roadtollRows.forEach((row, index) => {
                              const idInput = row.querySelector('input[name="roadtoll_id"]');
                              const roadtollRecord = {
                                RT_LINE_ID: idInput ? idInput.value : 'new',
                                EMIRATES: row.querySelector('select[name="AE_EMIRATES_LOOKUP_NAME"]').value,
                                TOLL_TYPE: row.querySelector('select[name="TOLL TYPE_LOOKUP_NAME"]').value,
                                ACCOUNT_NO: row.querySelector('input[name="ACCOUNT_NO"]').value,
                                TAG_NO: row.querySelector('input[name="TAG_NO"]').value,
                                ACTIVATION_DATE: row.querySelector('input[name="ACTIVATION_DATE"]').value,
                                
                                ACTIVATION_END_DATE: row.querySelector('input[name="ACTIVATION_END_DATE"]').value,
                                CURRENT_STATUS: row.querySelector('select[name="CURRENT STATUS_LOOKUP_NAME"]').value,
                                FLEET_PROCESS: commercialStatus
                              };
                              const filteredroadtollRecord = Object.fromEntries(
                                      Object.entries(roadtollRecord).filter(([key, value]) => value !== '' && value !== null)
                                  );

                                  roadtollData.push(filteredroadtollRecord);
    
                              const fileInput = row.querySelector('input[type="file"]');
                              if (fileInput && fileInput.files.length > 0) {
                                for (let i = 0; i < fileInput.files.length; i++) {
                                  formData.append(`RoadtollAttachments_${index}`, fileInput.files[i]);
                                }
                              }
                            });
                            formData.append('roadtoll', JSON.stringify(roadtollData));
                            formData.append('is_approver', fromApprover ? 'true' : 'false');
                        
                            // Process Allocation data
                            const allocationRows = document.querySelectorAll('#allocationTable tbody tr');
                            allocationRows.forEach((row, index) => {
                              const idInput = row.querySelector('input[name="allocation_id"]');
                              const allocationRecord = {
                                ALLOC_LINE_ID: idInput ? idInput.value : 'new',
                                COMPANY_NAME: row.querySelector('select[name="COMPANY NAME_LOOKUP_NAME"]').value,
                                DIVISION: row.querySelector('select[name="DIVISIONS_LOOKUP_NAME"]').value,
                                OPERATING_LOCATION: row.querySelector('select[name="OPERATING_LOCATION_ALLOCATION_LOOKUP_NAME"]').value,
                                OPERATING_EMIRATES: row.querySelector('select[name="AE_EMIRATES_LOOKUP_NAME"]').value,
                                APPICATION_USAGE: row.querySelector('input[name="APPICATION_USAGE"]').value,
                                ALLOCATION_DATE: row.querySelector('input[name="ALLOCATION_DATE"]').value,
                                
                                ALLOCATION_END_DATE: row.querySelector('input[name="ALLOCATION_END_DATE"]').value,
                                FLEET_PROCESS: commercialStatus
                              };
                              const filteredallocationRecord = Object.fromEntries(
                                      Object.entries(allocationRecord).filter(([key, value]) => value !== '' && value !== null)
                                  );

                                  allocationData.push(filteredallocationRecord);
    
                              const fileInput = row.querySelector('input[type="file"]');
                              if (fileInput && fileInput.files.length > 0) {
                                for (let i = 0; i < fileInput.files.length; i++) {
                                  formData.append(`attachment_${index}`, fileInput.files[i]);
                                }
                              }
                            });
                            formData.append('allocation', JSON.stringify(allocationData));
                            formData.append('is_approver', fromApprover ? 'true' : 'false');
                        
                            // Append JSON stringified data for each section
                            formData.append('insurances', JSON.stringify(insuranceData));
                            formData.append('registration', JSON.stringify(registrationData));
                            formData.append('roadtoll', JSON.stringify(roadtollData));
                            formData.append('allocation', JSON.stringify(allocationData));
                            if (action) {
                              formData.append('ACTION', action);
                          }

                            try {
                              const response = await fetch('http://127.0.0.1:8000/api/commercial-master', {
                                  method: 'POST',
                                  body: formData
                              });
                                const data = await response.json();
                          
                              if (!response.ok) {
                                  const errorText = await response.text();
                                  console.error('Error response:', errorText);
                                  throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                              }
                          

                              
                              console.log('Success:', data);
                              console.log('Data structure:', JSON.stringify(data, null, 2));
                      
                              if (data.commercial_master) {
                                const commercialControlNumber = data.commercial_master;


                              if (data.commercial_master && data.commercial_master.COMM_PLATE_NO) {
                                  commercialPlateInput.value = data.commercial_master.COMM_PLATE_NO;
                              }
                                
                                // Log COMM_CONTROL_NO for debugging
                                console.log('COMM_CONTROL_NO:', data.commercial_master.COMM_CONTROL_NO);
                                
                                if (action === 'Request For Cancellation') {
                                    try {
                                        await sendCancellationEmail(data.commercial_master.COMM_CONTROL_NO);
                                        console.log('Cancellation email sent successfully.');
                                    } catch (error) {
                                        console.error('Error sending cancellation email:', error);
                                    }
                                } else {
                                    try {
                                        await sendEmailAutomatically(data.commercial_master.COMM_CONTROL_NO, data.commercial_master, isNewSubmission);
                                        console.log('Submission email sent successfully.');
                                    } catch (error) {
                                        console.error('Error sending submission email:', error);
                                    }
                                }
                                window.isRequestingCancellation = false;
                            } else {
                                console.error('Unexpected API response:', data);
                                alert('Unexpected API response. Please check the console for details.');
                            }
                            
                            
                          
                               
                        
                              document.querySelectorAll('#insuranceTable tbody tr input, #insuranceTable tbody tr select').forEach(input => {
                                input.value = '';
                            });
                            document.querySelectorAll('input[type="file"]').forEach(input => {
                                input.value = '';
                            });
                    
                            let alertMessage = data.message || 'Commercial Master and related records created/updated successfully';
                            
                            // Get the commercial number from the form
                            const commercialNumber = document.querySelector('input[name="COMM_CONTROL_NO"]').value;
                            
                            if (commercialNumber) {
                                alertMessage += `\nCommercial Number: ${commercialNumber}`;
                            }
                            alert(alertMessage);
                                  clearForm();
                                  clearInsuranceTable();
                                  clearRegistrationTable();
                                  clearRoadtollTable();
                            clearAllocationTable();
                                     

                            } catch (error) {
                                console.error('Detailed error:', error);
                                //alert(`An error occurred while submitting the information: ${error.message}`);
                            }
                        });
                        
                                       
                        async function sendEmailAutomatically(commercialControlNumber, commercialData, isNewSubmission) {
                          console.log('Starting sendEmailAutomatically function');
                        
                          // Fetch complete fleet data
                          const response = await fetch(`http://127.0.0.1:8000/api/commercial-master/${commercialControlNumber}`);
                         const completeCommercialData = await response.json();
                          console.log('Complete Commercial Data:', JSON.stringify(completeCommercialData, null, 2));
                        
                          const lookupValue = isNewSubmission ? 'NEW_FLEET_MASTER' : 'EDIT_FLEET_MASTER';
                          console.log(`Using lookup value: ${lookupValue}`);
                        
                          const emailAddresses = await fetchEmailAddresses(lookupValue);
                          console.log('Fetched email addresses:', emailAddresses);
                        
                          if (!emailAddresses) {
                            console.error('Failed to fetch email addresses');
                            return;
                          }
                        
                          const { toEmail, ccEmail } = emailAddresses;
                          console.log(`To Email: ${toEmail}, CC Email: ${ccEmail}`);
                        
                          if (!toEmail) {
                            console.error('No valid TO email address found');
                            return;
                          }
                        
                          const plateNum = completeCommercialData.COMM_PLATE_NO || 'N/A';
                          //const registrationNo1 = completeCommercialData.registration && completeCommercialData.registration[0] ? completeCommercialData.registration[0].REGISTRATION_NO1 || 'N/A' : 'N/A';
                        
                          const subject = isNewSubmission
                            ?`Action required: New Commercial Entry Details ${commercialControlNumber}/${plateNum} requires your approval`
                            : `Action required: Modified Commercial Entry Details ${commercialControlNumber}/${plateNum}requires your approval`;
                          console.log(`Email subject: ${subject}`);
                        
                          let comparisonData = null;
                          if (!isNewSubmission) {
                            console.log('This is an edit submission, fetching comparison data');
                            try {
                              const headerId = completeCommercialData.HEADER_ID;
                              console.log(`Using HEADER_ID for comparison: ${headerId}`);
                              const comparisonResponse = await fetch(`http://127.0.0.1:8000/api/compare-data/${headerId}`);
                              console.log('Comparison data API response status:', comparisonResponse.status);
                        
                              if (!comparisonResponse.ok) {
                                throw new Error(`HTTP error! status: ${comparisonResponse.status}`);
                              }
                        
                              comparisonData = await comparisonResponse.json();
                              console.log('Comparison data received:', comparisonData);
                            } catch (error) {
                              console.error('Error fetching comparison data:', error);
                            }
                          }
                        
                          const formData = new FormData();
                          formData.append('recipient', toEmail);
                          formData.append('cc', ccEmail || '');
                          formData.append('bcc', '');
                          formData.append('subject', subject);
                          formData.append('data', JSON.stringify(completeCommercialData));
                          formData.append('custom_message', isNewSubmission ? 'New Commercial submission for your approval' : 'Updated fleet details for your approval');
                          formData.append('is_new_submission', isNewSubmission);
                        
                          if (comparisonData) {
                            formData.append('comparison_data', JSON.stringify(comparisonData));
                          }
                        
                          console.log('FormData created with all information');
                        
                          console.log('Sending email...');
                          try {
                            showEmailSendingPopup(
                              fetch('http://127.0.0.1:8000/api/send-commercial-email', {
                                method: 'POST',
                                body: formData
                              }).then(response => {
                                console.log('Email API response status:', response.status);
                                if (!response.ok) {
                                  throw new Error(`HTTP error! status: ${response.status}`);
                                }
                                return response.json();
                              }).then(result => {
                                if (result.status === 'success') {
                                  console.log('Email sent successfully!');
                                } else {
                                  throw new Error(result.message);
                                }
                              })
                            );
                          } catch (error) {
                            console.error('Error sending email:', error);
                           //alert(`Failed to send email: ${error.message}`);
                          }
                        
                          console.log('sendEmailAutomatically function completed');
                        } 

                        
                                   
                      
                        async function sendCancellationEmail(commercialControlNumber) {
                          try {
                              const emailAddresses = await fetchEmailAddresses('CANCEL_FLEET_MASTER');
                              if (!emailAddresses || !emailAddresses.toEmail) {
                                  throw new Error('No valid email addresses found for CANCEL_FLEET_MASTER');
                              }
  
                              const commercialResponse = await fetch(`http://127.0.0.1:8000/api/commercial-master/${commercialControlNumber}`);
                              const completeCommercialData = await commercialResponse.json();
  
                              const plateNum = completeCommercialData.COMM_PLATE_NO || 'N/A';
  
                              const subject = `Action Required : Cancellation Request for Commercial Details : ${commercialControlNumber}/${plateNum}`;
  
                              const formData = new FormData();
                              formData.append('recipient', emailAddresses.toEmail);
                              formData.append('cc', emailAddresses.ccEmail || '');
                              formData.append('subject', subject);
                              formData.append('custom_message', 'A cancellation request has been submitted for the following fleet:');
                              formData.append('data', JSON.stringify(completeCommercialData));
  
                              showEmailSendingPopup(
                                  fetch('http://127.0.0.1:8000/api/send-commercial-email', {
                                      method: 'POST',
                                      body: formData
                                  }).then(response => {
                                      if (!response.ok) {
                                          throw new Error(`HTTP error! status: ${response.status}`);
                                      }
                                      return response.json();
                                  }).then(result => {
                                      if (result.status !== 'success') {
                                          throw new Error(result.message);
                                      }
                                      console.log('Cancellation email sent successfully');
                                  })
                              );
                          } catch (error) {
                              console.error('Error:', error);
                              alert(`Failed to send cancellation email: ${error.message}`);
                          }
                      }
  
  
                      const cancelBtn = document.getElementById('cancelForm');
                      if (cancelBtn) {
                          cancelBtn.addEventListener('click', function() {
                              const statusInput = document.querySelector('input[name="STATUS"]');
                              statusInput.value = 'Request For Cancellation';
                              
                              if (confirm('Are you sure you want to request cancellation for this fleet?')) {
                                  // Instead of calling submitForm directly, we'll set a flag and trigger the submit button
                                  window.isRequestingCancellation = true;
                                  document.getElementById('submitForm').click();
                              } else {
                                  statusInput.value = ''; // Reset if user cancels
                              }
                          });
                      }                        
                      function showEmailSendingPopup(promise) {
                          const popup = document.createElement('div');
                          popup.style.position = 'fixed';
                          popup.style.top = '50%';
                          popup.style.left = '50%';
                          popup.style.transform = 'translate(-50%, -50%)';
                          popup.style.background = 'white';
                          popup.style.padding = '20px';
                          popup.style.borderRadius = '10px';
                          popup.style.boxShadow = '0 0 10px rgba(0,0,0,0.5)';
                          popup.style.zIndex = '1000';
                          popup.innerHTML = `
                              <p>Sending email...</p>
                              <div class="spinner"></div>
                          `;
                          document.body.appendChild(popup);

                          promise.then(() => {
                              popup.innerHTML = '<p>Email sent successfully!</p>';
                              setTimeout(() => {
                                  document.body.removeChild(popup);
                              }, 2000);
                          }).catch(error => {
                              popup.innerHTML = `<p>Error sending email: ${error.message}</p>`;
                              setTimeout(() => {
                                  document.body.removeChild(popup);
                              }, 3000);
                          });
                        }

                        let storedEmailAddresses = null;

                        async function fetchAndStoreEmailAddresses() {
                          if (!storedEmailAddresses) {
                            try {
                              const response = await fetch('http://127.0.0.1:8000/api/related-data/?lookup_name=EMAIL_SETUPS');
                              if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                              }
                              storedEmailAddresses = await response.json();
                            } catch (error) {
                              console.error('Error fetching email addresses:', error);
                              storedEmailAddresses = null;
                            }
                          }
                          return storedEmailAddresses;
                        }


                        async function fetchEmailAddresses(lookupValue) {
                          try {
                              const response = await fetch(`http://127.0.0.1:8000/api/related-data/?lookup_value=${lookupValue}`);
                              if (!response.ok) {
                                  throw new Error(`HTTP error! status: ${response.status}`);
                              }
                              const data = await response.json();
                              
                              const toEmail = data.find(item => item.LOOKUP_CODE === 'TO' && item.ACTIVE === 'Y')?.MEANING;
                              const ccEmail = data.find(item => item.LOOKUP_CODE === 'CC' && item.ACTIVE === 'Y')?.MEANING;
                              
                              return { toEmail, ccEmail };
                          } catch (error) {
                              console.error(`Error fetching email addresses for ${lookupValue}:`, error);
                              return null;
                          }
                        }
                  

                        
                        async function showComposeModal(commercialControlNumber, action = '', isApprover = false,comment = '') {
                          console.log('Action received in showComposeModal:', action);
                          const emailAddresses = await fetchAndStoreEmailAddresses();
                          let toEmail = '';
                          let ccEmails = '';
                          if (emailAddresses) {
                              const toEmailObj = emailAddresses.find(item => item.LOOKUP_CODE === 'TO' && item.ACTIVE === 'Y');
                              const ccEmailsObj = emailAddresses.find(item => item.LOOKUP_CODE === 'CC' && item.ACTIVE === 'Y');
                              if (toEmailObj) toEmail = toEmailObj.MEANING;
                              if (ccEmailsObj) ccEmails = ccEmailsObj.MEANING;
                          }
                      
                          try {
                              const response = await fetch(`http://127.0.0.1:8000/api/commercial-master/${commercialControlNumber}`);
                              if (!response.ok) {
                                  throw new Error(`HTTP error! status: ${response.status}`);
                              }
                              const data = await response.json();
                              data.COMMENTS = comment;
                              const plateNum = data.COMM_PLATE_NO || 'N/A';
                              let subject;
                              const commercialInfo = `${commercialControlNumber}/${plateNum}`;
                              let newStatus = '';
                              if (isApprover && action) {
                                  switch(action) {
                                      case 'Return for Correction':
                                        newStatus = 'Return for Correction';
                                        subject = `Commercial Entry Details : ${commercialInfo} request is return for correction.`;
                                          break;
                                      case 'Approved':
                                          newStatus = 'Approved';
                                          subject = `Commercial Entry Details : ${commercialInfo} has been your approved.`;
                                          break;
                                      case 'Cancelled':
                                          subject = `Action Required: Commercial Details ${commercialInfo} cancelled`;
                                          break;
                                      case 'Defleet':
                                          newStatus = 'Defleet';
                                          subject = `Commercial ${commercialInfo} request has been defleeted.`;
                                          break;
                                      default:
                                          subject = `Commercial Entry Details : ${commercialInfo} requires your attention`;
                                  }
                              } else {
                                  // Non-approver submission
                                  subject = `New Commercial ${commercialInfo} requires for approval`;
                                  action = 'Modified'; 
                              }
                              data.STATUS = newStatus;
                      
                              console.log('Subject set:', subject);
                      
                              const formData = new FormData();
                              formData.append('data', JSON.stringify(data));
                              formData.append('recipient', toEmail);
                              formData.append('cc', ccEmails);
                              formData.append('subject', subject);
                              formData.append('data', JSON.stringify(data));
                              formData.append('is_approver_action', isApprover.toString());
                              formData.append('action', action);
                              formData.append('is_new_submission', (!isApprover).toString()); // Add this line
                              
                      
                              
                              const emailResponse = await fetch('http://127.0.0.1:8000/api/send-commercial-email', {
                                  method: 'POST',
                                  body: formData
                              });
                      
                              if (!emailResponse.ok) {
                                  throw new Error(`HTTP error! status: ${emailResponse.status}`);
                              }
                      
                              const result = await emailResponse.json();
                              if (result.status === 'success') {
                                  console.log('Email sent successfully!');
                                  if (window.submitFormAfterEmail) {
                                      window.submitFormAfterEmail();
                                  }
                              } else {
                                  throw new Error(result.message);
                              }
                          } catch (error) {
                              console.error('Error fetching commercial info or sending email:', error);
                              //alert(`Failed to send email: ${error.message}`);
                          }
                      }
                      

                      
                      
                      const saveButton = document.getElementById('saveform');
                      saveButton.addEventListener('click', async function (event) {
                        if (isPopulatedData && !isEditMode) {
                          alert("Please enable editing first.");
                          return;
                        }
    
                       
    
                        const form = document.getElementById('commercialForm');
                        const formData = new FormData(form);

                  // Handle empty date fields
                    document.querySelectorAll('input[type="date"]').forEach(dateInput => {
                        if (dateInput.value === '') {
                            formData.set(dateInput.name, null);
                        }
                    });
    
                        const fieldMappings = {
                          'COMPANY NAME_LOOKUP_NAME': 'COMPANY_NAME',
                          'VEHICLE TYPE_LOOKUP_NAME': 'CP_VEHICLE_TYPE',
                          'ISSUING AUTHORITY_LOOKUP_NAME': 'CP_ISSUED_AUTHORITY',
                          'COLOR_LOOKUP_NAME': 'CP_COLOR',
                          'FLEET CATEGORY_LOOKUP_NAME': 'COMM_PLATE_CATEGORY',
                          
                        };
    
                        for (let [lookupName, mapping] of Object.entries(fieldMappings)) {
                          const select = form.querySelector(`select[name="${lookupName}"]`);
                          if (select && select.value) {
                            if (typeof mapping === 'object' && mapping.handler) {
                              formData.append(mapping.apiName, mapping.handler(select.value));
                            } else {
                              formData.append(typeof mapping === 'string' ? mapping : mapping.apiName, select.value);
                            }
                          }
                        }
    
                        const insuranceData = [];         
                        const registrationData = [];
                        const roadtollData = [];
                        const allocationData = [];
    
                        const insuranceRows = document.querySelectorAll('#insuranceTable tbody tr');
                        insuranceRows.forEach((row, index) => {
                          const idInput = row.querySelector('input[name="insurance_id"]');
                          const insuranceCompany = row.querySelector('input[name="INSURANCE_COMPANY"]')?.value || '';

                            // Skip empty rows
                            if (!insuranceCompany.trim()) {
                              return; // Skip this iteration if the Insurance Company is empty
                            }

                          const insuranceRecord = {
                            INS_LINE_ID: idInput ? idInput.value : 'new',
                              INSURANCE_COMPANY: insuranceCompany,
                              POLICY_NO: row.querySelector('input[name="POLICY_NO"]')?.value || '',
                              POLICY_DATE: row.querySelector('input[name="POLICY_DATE"]')?.value || null,
                              POLICY_EXPIRY_DATE: row.querySelector('input[name="POLICY_EXPIRY_DATE"]')?.value || null,
                              PLTS_INS_START_DATE: row.querySelector('input[name="PLTS_INS_START_DATE"]')?.value || null,
                              PLTS_INS_EXPIRY_DATE: row.querySelector('input[name="PLTS_INS_EXPIRY_DATE"]')?.value || null,
                              CUR_STAT_MOT_INS: row.querySelector('select[name="CURRENT STATUS_LOOKUP_NAME"]')?.value || null
                          };
                          insuranceData.push(insuranceRecord);
                          const fileInput = row.querySelector('input[type="file"]');
                          if (fileInput && fileInput.files.length > 0) {
                            for (let i = 0; i < fileInput.files.length; i++) {
                              formData.append(`InsurancePolicAattachment_${index}`, fileInput.files[i]);
                            }
                          }
                        });
                        formData.append('insurances', JSON.stringify(insuranceData));
    
                        
                       
                        const registrationRows = document.querySelectorAll('#registrationTable tbody tr');
                        registrationRows.forEach((row, index) => {
                          const idInput = row.querySelector('input[name="registration_id"]');
                          const emiratesTrafficFileNumber = row.querySelector('input[name="EMIRATES_TRF_FILE_NO"]')?.value || '';
                          
                          // Skip empty rows
                          if (!emiratesTrafficFileNumber.trim()) {
                            return; // Skip this iteration if the EmiratesTrafficFileNumber is empty
                          }                          
                          const registrationRecord = {
                            REG_LINE_ID: idInput ? idInput.value : 'new',
                            EMIRATES_TRF_FILE_NO: emiratesTrafficFileNumber,
                            REGISTERED_EMIRATES: row.querySelector('input[name="REGISTERED_EMIRATES"]')?.value || null,
                            FEDERAL_TRF_FILE_NO: row.querySelector('input[name="FEDERAL_TRF_FILE_NO"]')?.value || null,
                            REG_COMPANY_NAME: row.querySelector('input[name="REG_COMPANY_NAME"]')?.value || null,
                            TRADE_LICENSE_NO: row.querySelector('input[name="TRADE_LICENSE_NO"]')?.value || null,
                            REGISTRATION_NO1: row.querySelector('input[name="REGISTRATION_NO1"]')?.value || null,
                            REGISTRATION_NO: row.querySelector('input[name="REGISTRATION_NO"]')?.value || null,
                            REGISTRATION_DATE: row.querySelector('input[name="REGISTRATION_DATE"]')?.value || null,
                            REG_EXPIRY_DATE: row.querySelector('input[name="REG_EXPIRY_DATE"]')?.value || null,
                            CUR_STAT_REG: row.querySelector('select[name="CURRENT STATUS_LOOKUP_NAME"]')?.value || ''
                          };
                          registrationData.push(registrationRecord);
                          const fileInput = row.querySelector('input[type="file"]');
                          if (fileInput && fileInput.files.length > 0) {
                            for (let i = 0; i < fileInput.files.length; i++) {
                              formData.append(`RegCardAttachment_${index}`, fileInput.files[i]);
                            }
                          }
                        });
                        formData.append('registration', JSON.stringify(registrationData));
    
                       
                        const roadtollRows = document.querySelectorAll('#roadtollTable tbody tr');
                        roadtollRows.forEach((row, index) => {
                          const idInput = row.querySelector('input[name="roadtoll_id"]');
                          const roadtollRecord = {
                            RT_LINE_ID: idInput ? idInput.value : 'new',
                            EMIRATES: row.querySelector('select[name="AE_EMIRATES_LOOKUP_NAME"]').value || null,
                            TOLL_TYPE: row.querySelector('select[name="TOLL TYPE_LOOKUP_NAME"]').value || null,
                            ACCOUNT_NO: row.querySelector('input[name="ACCOUNT_NO"]').value || null,
                            TAG_NO: row.querySelector('input[name="TAG_NO"]').value || null,
                            ACTIVATION_DATE: row.querySelector('input[name="ACTIVATION_DATE"]').value || null,
                            ACTIVATION_END_DATE: row.querySelector('input[name="ACTIVATION_END_DATE"]').value || null,
                            CURRENT_STATUS: row.querySelector('select[name="CURRENT STATUS_LOOKUP_NAME"]').value || null
                          };
                          roadtollData.push(roadtollRecord);
                          const fileInput = row.querySelector('input[type="file"]');
                          if (fileInput && fileInput.files.length > 0) {
                            for (let i = 0; i < fileInput.files.length; i++) {
                              formData.append(`RoadtollAttachments_${index}`, fileInput.files[i]);
                            }
                          }
                        });
                        formData.append('roadtoll', JSON.stringify(roadtollData));
    
                        
                        const allocationRows = document.querySelectorAll('#allocationTable tbody tr');
                        allocationRows.forEach((row, index) => {
                          const idInput = row.querySelector('input[name="allocation_id"]');
                          const allocationRecord = {
                            ALLOC_LINE_ID: idInput ? idInput.value : 'new',
                            COMPANY_NAME: row.querySelector('select[name="COMPANY NAME_LOOKUP_NAME"]').value || null,
                            DIVISION: row.querySelector('select[name="DIVISIONS_LOOKUP_NAME"]').value || null,
                            OPERATING_LOCATION: row.querySelector('select[name="OPERATING_LOCATION_ALLOCATION_LOOKUP_NAME"]').value || null,
                            OPERATING_EMIRATES: row.querySelector('select[name="AE_EMIRATES_LOOKUP_NAME"]').value || null,
                            APPICATION_USAGE: row.querySelector('input[name="APPICATION_USAGE"]').value || null,
                            ALLOCATION_DATE: row.querySelector('input[name="ALLOCATION_DATE"]').value || null,
                            ALLOCATION_END_DATE: row.querySelector('input[name="ALLOCATION_END_DATE"]').value || null,
                          };
                          allocationData.push(allocationRecord);
                          const fileInput = row.querySelector('input[type="file"]');
                          if (fileInput && fileInput.files.length > 0) {
                            for (let i = 0; i < fileInput.files.length; i++) {
                              formData.append(`attachment_${index}`, fileInput.files[i]);
                            }
                          }
                        });
                        formData.append('allocation', JSON.stringify(allocationData));
                        
                        console.log('insurances:', JSON.stringify(insuranceData));
                        console.log('registration:', JSON.stringify(registrationData));
                        console.log('roadtoll:', JSON.stringify(roadtollData));
                        console.log('allocation:', JSON.stringify(allocationData));
    
                        try {
                          const response = await fetch('http://127.0.0.1:8000/api/commercial-master/save', {
                            method: 'POST',
                            body: formData
                          });
                        
                          if (!response.ok) {
                            const errorText = await response.text();
                            console.error('Error response:', errorText);
                            throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                          }
                        
                          const data = await response.json();
                          console.log('Success:', data);
                        
                          if (data && data.commercial_master && data.commercial_master.HEADER_ID) {
                                alert(`Commercial master information saved successfully!\nHeader Id: ${data.commercial_master.HEADER_ID}`);
                                clearForm();
                            } else {
                                throw new Error('Invalid response data');
                            }
                        } catch (error) {
                            console.error('Detailed error:', error);
                            alert(`An error occurred while saving the information: ${error.message}`);
                        }
                    });
    
                      function areAllTablesFilled() {
                        const tables = ['insuranceTable', 'registrationTable','roadtollTable','allocationTable'];
                        return tables.every(tableId => {
                          const table = document.getElementById(tableId);
                          const rows = table.querySelectorAll('tbody tr');
                          return Array.from(rows).some(row => {
                            const inputs = row.querySelectorAll('input:not([type="hidden"]), select');
                            return Array.from(inputs).some(input => input.value.trim() !== '');
                          });
                        });
                      }
                      
                      function clearForm() {
                        document.querySelectorAll('#commercialForm input, #commercialForm select, #commercialForm textarea').forEach(input => {
                            if (input.type !== 'file') {
                                input.value = '';
                            } else {
                                // Clear file inputs
                                input.value = '';
                                // Clear any associated file name display
                                const fileLabel = input.nextElementSibling;
                                if (fileLabel && fileLabel.tagName === 'SPAN') {
                                    fileLabel.textContent = '';
                                }
                            }
                          });
    
                        
    
                          clearInsuranceTable();                                                  
                        
                          clearRegistrationTable();
                          clearRoadtollTable();
                         
                          clearAllocationTable();
    
    
                          enableEditingControls();
                          hideEditButton();
                          isPopulatedData = false;
                          enableAllFields();
                          const editButton = document.getElementById('editButton');
                          if (editButton) {
                            editButton.style.display = 'none';
                          }
    
                          isEditMode = false;
                          const commercialControlNumberField= document.querySelector('[name="COMM_CONTROL_NO"]');
                          commercialControlNumberField.disabled = true;
                          commercialControlNumberField.value = '';
                          
                      }
    
                      function clearInsuranceTable() {
                        const insuranceTable = document.querySelector('#insuranceTable tbody');
                        insuranceTable.innerHTML = '';
                        //addInsuranceRow();
                      }
    
                      function clearRegistrationTable() {
                        const registrationTable = document.querySelector('#registrationTable tbody');
                        registrationTable.innerHTML = '';
                        //addregistrationRow();
                      }
    
                   
    
                      function clearRoadtollTable() {
                        const roadtollTable = document.querySelector('#roadtollTable tbody');
                        roadtollTable.innerHTML = '';
                        //addRoadtollRow();
                      }
    
    
                      function clearAllocationTable() {
                        const allocationTable = document.querySelector('#allocationTable tbody');
                        allocationTable.innerHTML = '';
                        //addAllocationRow();
                      }
    
                  
                      function handleFileSelection(fileInput) {
                        const newFiles = fileInput.files;
                        let fileListContainer = fileInput.nextElementSibling;
                        let fileDropdown;
                      
                        if (!fileListContainer || !fileListContainer.classList.contains('file-list-container')) {
                          fileListContainer = document.createElement('div');
                          fileListContainer.className = 'file-list-container';
                          fileInput.parentNode.insertBefore(fileListContainer, fileInput.nextSibling);
                      
                          const wrapper = document.createElement('div');
                          wrapper.className = 'file-input-wrapper';
                          fileInput.parentNode.insertBefore(wrapper, fileInput);
                          wrapper.appendChild(fileInput);
                          wrapper.appendChild(fileListContainer);
                      
                          fileDropdown = createFileDropdown();
                          fileListContainer.appendChild(fileDropdown);
                        } else {
                          fileDropdown = fileListContainer.querySelector('.file-dropdown');
                        }
                      
                        const existingFiles = Array.from(fileDropdown.querySelectorAll('.file-item')).map(item => item.dataset.fileName);
                        const newFileNames = Array.from(newFiles).map(file => file.name);
                        
                        // Only add files that don't already exist
                        const filesToAdd = newFileNames.filter(fileName => !existingFiles.includes(fileName));
                      
                        for (let i = 0; i < filesToAdd.length; i++) {
                          const fileName = filesToAdd[i];
                          const fileItem = createFileItem(fileName, '', '', existingFiles.length + i);
                          fileDropdown.querySelector('.file-list').insertAdjacentHTML('beforeend', fileItem);
                        }
    
                        // Combine existing files and new files without duplicates
                        const allFiles = [...new Set([...existingFiles, ...filesToAdd])];
    
                        updateFileInput(fileInput, allFiles);
                        addRemoveFileListeners(fileDropdown, fileInput);
                        updateFileCount(fileInput, fileDropdown);
                      }
    
                      function createFileItem(fileName, modelName, instanceId, index) {
                        return `
                          <div class="file-item" data-file-name="${fileName}">
                              <div class="file-content">
                              <i class="fa-solid fa-paperclip file-icon"></i>
                                <span class="file-name">${fileName}</span>
                              </div>
                              <div class="remove-file-container">
                              <i class="fas fa-times remove-file" data-file-name="${fileName}" data-model="${modelName}" data-instance="${instanceId}" data-index="${index}"></i>
                            </div>
                              </div>
                            `;
                      }
    
                      function toggleFileList(event) {
                        const fileList = event.currentTarget.nextElementSibling;
                        fileList.style.display = fileList.style.display === 'none' ? 'block' : 'none';
                      }
    
                      function createFileDropdown() {
                        const dropdown = document.createElement('div');
                        dropdown.className = 'file-dropdown';
                        dropdown.innerHTML = `
                          <div class="dropdown-toggle">
                            <i class="fas fa-chevron-down"></i> <span class="file-count">0 file(s)</span>
                          </div>
                          <div class="file-list" style="display: none;"></div>
                        `;
                        dropdown.querySelector('.dropdown-toggle').addEventListener('click', toggleFileList);
                        return dropdown;
                      }
                      
    
    
                      function updateFileCount(fileInput, fileDropdown) {
                        const fileCount = fileDropdown.querySelectorAll('.file-item').length;
                        const fileCountSpan = fileDropdown.querySelector('.file-count');
                        fileCountSpan.textContent = `${fileCount} file(s)`;
    
                        const fileList = fileDropdown.querySelector('.file-list');
                        if (fileCount > 2) {
                          fileList.style.maxHeight = '150px';
                          fileList.style.overflowY = 'auto';
                        } else {
                          fileList.style.maxHeight = 'none';
                          fileList.style.overflowY = 'visible';
                        }
                      }
    
    
                      
                      function addRemoveFileListeners(fileListContainer, fileInput) {
                        fileListContainer.querySelectorAll('.remove-file').forEach(removeIcon => {
                          removeIcon.addEventListener('click', function() {
                            const fileName = this.dataset.fileName;
                            const modelName = this.dataset.model;
                            const instanceId = this.dataset.instance;
                            const index = this.dataset.index;
    
                            if (modelName && instanceId) {
                              deleteFile(modelName, instanceId, index, fileName);
                            } else {
                            const fileItem = this.closest('.file-item');
                            fileItem.remove();
    
                              const existingFiles = Array.from(fileListContainer.querySelectorAll('.file-item')).map(item => item.dataset.fileName);
                            updateFileInput(fileInput, existingFiles);
                              updateFileCount(fileInput, fileListContainer.querySelector('.file-dropdown'));
                            }
                          });
                        });
                      }
    
    
                      function updateFileInput(fileInput, fileNames) {
                        const dt = new DataTransfer();
                        const existingFiles = Array.from(fileInput.files);
    
                        fileNames.forEach(fileName => {
                          const file = existingFiles.find(f => f.name === fileName);
                          if (file && file.size > 0) {
                            dt.items.add(file);
                          } else if (fileName.trim() !== '') {
                            // Create a placeholder file for existing filenames
                            dt.items.add(new File([], fileName, { type: 'application/octet-stream' }));
                          }
                        });
    
                        fileInput.files = dt.files;
                      } 
    
                    
                      function addFileInputListeners() {
                        const fileInputs = document.querySelectorAll('input[type="file"]');
                        fileInputs.forEach(input => {
                          input.addEventListener('change', function () {
                            handleFileSelection(this);
                          });
                        });
                      }
    
    
                      function handleFileSelectionWrapper() {
                        handleFileSelection(this);
                      } 
                      
                     
                      function setupDropdownsForNewRow(row) {
                        setupTrafficSearchFunctionality(row);
    
                        row.querySelectorAll("select").forEach((dropdown) => {
                        const lookupName = dropdown.getAttribute("name").replace('_LOOKUP_NAME', '').trim();
                        if (lookupName) {
                          // Fetch dropdown options when clicked
                          dropdown.addEventListener("click", () => fetchDropdownOptions(lookupName, dropdown));
                        }
                        // Store the selected value as a data attribute for later use
                        dropdown.addEventListener("change", function () {
                          this.setAttribute("data-selected", this.value);
                        });
                      });
                    }
    
                    
    
                          let insuranceFileInfo = [];
                          let activeInsuranceSearchInput = null;
                      
                      function addInsuranceRow() {
                        const tbody = document.querySelector('#insuranceTable tbody');
                        const newRow = tbody.insertRow();
    
                        newRow.innerHTML = `
                                  <td>
                                    <input type="text" class="form-control insurance-search-input" name="INSURANCE_COMPANY" required style="background-color: #ffff76; color: black"/>
                                    <div class="insurance-search-results-container" style="display: none;">
                                      <div class="insurance-search-results-header">
                                        <span>Insurance File Search Results</span>
                                        <span class="insurance-close-icon">&times;</span>
                                      </div>
                                      <table class="insurance-search-results">
                                        <thead>
                                          <tr>
                                            <th>Insurance Company</th>
                                            <th>Policy No</th>
                                            <th>Policy Date</th>
                                            <th>Policy Expiry Date</th>
                                          </tr>
                                        </thead>
                                        <tbody></tbody>
                                      </table>
                                    </div>
                                  </td>
                                    <td><input type="text" class="form-control" name="POLICY_NO" required style="background-color: #ffff76; color: black"/></td>
                                    <td><input type="date" class="form-control" name="POLICY_DATE" required style="background-color: #ffff76; color: black"/></td>
                                    <td><input type="date" class="form-control" name="POLICY_EXPIRY_DATE" required style="background-color: #ffff76; color: black"/></td>
                                    <td><input type="date" class="form-control" name="PLTS_INS_START_DATE" style="background-color: #ffff76; color: black"/></td>
                                    <td><input type="date" class="form-control" name="PLTS_INS_EXPIRY_DATE"  style="background-color: #ffff76; color: black"/></td>
                                    <td><select class="form-control" name="CURRENT STATUS_LOOKUP_NAME" style="background-color: #ffff76; color: black"><option value=""></option></select></td>
                              <td><input type="file" class="form-control" name="InsurancePolicAattachment" /></td>
                              <input type="hidden" name="insurance_id" value="new" />
                              <input type="hidden" name="FLEET_PROCESS" value="Pending" />
                            `;

                                    setupDropdownsForNewRow(newRow);
                                    setupValidation(newRow);
                                    addFileInputListeners();
                                    setupInsuranceSearchFunctionality(newRow);
                                  }

                                  function setupInsuranceSearchFunctionality(row) {
                                    const searchInput = row.querySelector('.insurance-search-input');
                                    if (!searchInput) {
                                      console.warn('Insurance search input not found in the row');
                                      return;
                                    }

                                    console.log('Setting up insurance search functionality for:', searchInput);

                                    searchInput.addEventListener('focus', (event) => {
                                      console.log('Focus event triggered on:', event.target);
                                      activeInsuranceSearchInput = searchInput;
                                    
                                      const fieldsToReset = ['INSURANCE_COMPANY', 'POLICY_NO', 'POLICY_DATE', 'POLICY_EXPIRY_DATE', ];
                                      fieldsToReset.forEach(fieldName => {
                                        const input = row.querySelector(`input[name="${fieldName}"]`);
                                        if (input) {
                                          input.readOnly = false;
                                          input.classList.remove('read-only-field');
                                        }
                                      });

                                      fetchAndPopulateInsuranceFileResults(searchInput);
                                    });

                                    searchInput.addEventListener('input', (event) => {
                                      console.log('Input event triggered on:', event.target);
                                      fetchAndPopulateInsuranceFileResults(searchInput);
                                    });
                                  }

                                  function initializeInsuranceFileInput() {
                                    console.log('Initializing insurance file input');
                                    const insuranceTable = document.getElementById('insuranceTable');
                                    if (insuranceTable) {
                                      const fileInputs = insuranceTable.querySelectorAll('input[type="file"]');
                                      console.log('Insurance file inputs:', fileInputs);
                                      fileInputs.forEach(input => {
                                        input.addEventListener('change', function() {
                                          console.log('Insurance file input changed');
                                          handleFileSelection(this);
                                        });
                                      });
                                    } else {
                                      console.warn('Insurance table not found');
                                    }
                                  }

                                  function reinitializeInsuranceFileInputs() {
                                    console.log('Reinitializing all insurance file inputs');
                              addFileInputListeners();
                              initializeInsuranceFileInput();
                            }

                            const originalAddInsuranceRow = addInsuranceRow;
                            addInsuranceRow = function() {
                              originalAddInsuranceRow();
                              console.log('Insurance row added, reinitializing file inputs');
                              reinitializeInsuranceFileInputs();
                            };

                            const insuranceTableObserver = new MutationObserver((mutations) => {
                              mutations.forEach((mutation) => {
                                if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                                  console.log('Insurance table changed, reinitializing file inputs');
                                  reinitializeInsuranceFileInputs();
                                }
                              });
                            });

                            document.addEventListener('DOMContentLoaded', function() {
                              console.log('DOM fully loaded');
                              reinitializeInsuranceFileInputs();

                              const insuranceTable = document.getElementById('insuranceTable');
                              if (insuranceTable) {
                                insuranceTableObserver.observe(insuranceTable, { childList: true, subtree: true });
                              }
                            });

                            const globalInsuranceSearchResults = document.getElementById('globalInsuranceSearchResults');
                            const closeInsuranceIcons = globalInsuranceSearchResults.querySelector('.insurance-close-icon');

                            closeInsuranceIcons.addEventListener('click', (e) => {
                              console.log('Close icon clicked');
                              e.stopPropagation();
                              hideInsuranceSearchResults();
                            });

                            document.addEventListener('click', (event) => {
                              if (!event.target.closest('.insurance-search-input') && !event.target.closest('#globalInsuranceSearchResults')) {
                                hideInsuranceSearchResults();
                              }
                            });

                            async function fetchAndPopulateInsuranceFileResults(searchInput) {
                              console.log('Fetching and populating insurance file results');
                              try {
                                await fetchInsuranceFileInfo();
                                filterAndDisplayInsuranceFileResults(searchInput);
                                showInsuranceSearchResults();
                              } catch (error) {
                                console.error('Error fetching insurance file info:', error);
                              }
                            }

                            function filterAndDisplayInsuranceFileResults(searchInput) {
                              console.log('Filtering and displaying insurance file results');
                              const searchTerm = searchInput.value.toLowerCase();
                              const filteredInfo = insuranceFileInfo.filter(info =>
                                info.INSURANCE_COMPANY.toLowerCase().includes(searchTerm)
                              );

                              console.log('Filtered info:', filteredInfo);

                              const searchResults = globalInsuranceSearchResults.querySelector('.insurance-search-results tbody');
                              searchResults.innerHTML = '';
                              filteredInfo.forEach((info) => {
                                const tr = document.createElement('tr');
                                tr.innerHTML = `
                                  <td>${info.INSURANCE_COMPANY}</td>
                                  <td>${info.POLICY_NO}</td>
                                  <td>${info.POLICY_DATE}</td>
                                  <td>${info.POLICY_EXPIRY_DATE}</td>
                                `;
                                tr.addEventListener('click', function (e) {
                                  console.log('Search result clicked');
                                  e.stopPropagation();
                                  populateInsuranceFields(activeInsuranceSearchInput, info);
                                  hideInsuranceSearchResults();
                                });
                                searchResults.appendChild(tr);
                              });
                            }

                            function showInsuranceSearchResults() {
                              console.log('Showing insurance search results');
                              globalInsuranceSearchResults.style.display = 'block';
                            }

                            function hideInsuranceSearchResults() {
                              console.log('Hiding insurance search results');
                              globalInsuranceSearchResults.style.display = 'none';
                            }

                            async function fetchInsuranceFileInfo() {
                              if (insuranceFileInfo.length === 0) {
                                console.log('Fetching insurance file info from API');
                                try {
                                  const response = await fetch('http://127.0.0.1:8000/api/insurance-info');
                                  if (!response.ok) {
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                  }
                                  insuranceFileInfo = await response.json();
                                  console.log('Fetched insurance file info:', insuranceFileInfo);
                                } catch (error) {
                                  console.error('Error fetching insurance file info:', error);
                                }
                              } else {
                                console.log('Using cached insurance file info');
                              }
                              return insuranceFileInfo;
                            }

                            function populateInsuranceFields(searchInput, info) {
                              console.log('Populating insurance fields with:', info);
                              const row = searchInput.closest('tr');
                            
                              const fieldsToPopulate = [
                                { name: 'INSURANCE_COMPANY', value: info.INSURANCE_COMPANY },
                                { name: 'POLICY_NO', value: info.POLICY_NO },
                                { name: 'POLICY_DATE', value: info.POLICY_DATE },
                                { name: 'POLICY_EXPIRY_DATE', value: info.POLICY_EXPIRY_DATE },
                              ];

                              fieldsToPopulate.forEach(field => {
                                const input = row.querySelector(`input[name="${field.name}"]`);
                                if (input) {
                                  input.value = field.value;
                                  input.readOnly = true;
                                  input.classList.add('read-only-field');
                                }
                              });

                              const insuranceCompanyInput = row.querySelector('input[name="INSURANCE_COMPANY"]');
                              insuranceCompanyInput.addEventListener('focus', function() {
                                fieldsToPopulate.forEach(field => {
                                  const input = row.querySelector(`input[name="${field.name}"]`);
                                  if (input) {
                                    input.readOnly = false;
                                    input.classList.remove('read-only-field');
                                  }
                                });
                              });
                            }

                            document.addEventListener('DOMContentLoaded', () => {
                              console.log('DOM content loaded');
                              const existingRows = document.querySelectorAll('#insuranceTable tbody tr');
                              existingRows.forEach(row => setupInsuranceSearchFunctionality(row));
                            });

    
                      let trafficFileInfo = [];
                      let activeSearchInput = null;
    
    
                      // Function to add a new registration row with dynamic dropdowns
                      function addRegistrationRow() {
                        const tbody = document.querySelector('#registrationTable tbody');
                        const newRow = tbody.insertRow();
    
                        // Create the HTML for the new row with dropdowns
                        newRow.innerHTML = `
                          <td>
                                            <input type="text" class="form-control traffic-search-input" name="EMIRATES_TRF_FILE_NO" required style="background-color: #ffff76; color: black"/>
                              </td>  
                                      <td><input type="text" class="form-control" name="REGISTERED_EMIRATES" required /></td>
                            
                                      <td><input type="text" class="form-control" name="FEDERAL_TRF_FILE_NO" required/></td>
                                      <td><input type="text" class="form-control" name="REG_COMPANY_NAME" required/></td>
                                      <td><input type="text" class="form-control" name="TRADE_LICENSE_NO" required/></td>
                                      <td><input type="text" class="form-control" name="REGISTRATION_NO1" style="background-color: #ffff76; color: black"/></td>
                                      <td><input type="text" class="form-control" name="REGISTRATION_NO" style="background-color: #ffff76; color: black"/></td>
                                      <td><input type="date" class="form-control" name="REGISTRATION_DATE" style="background-color: #ffff76; color: black"/></td>
                                      <td><input type="date" class="form-control" name="REG_EXPIRY_DATE" style="background-color: #ffff76; color: black" /></td>
                                      <td><select class="form-control" name="CURRENT STATUS_LOOKUP_NAME" style="background-color: #ffff76; color: black" ><option value=""></option></select> </td>
                                      <td><input type="file" class="form-control" name="RegCardAttachment"/></td>
                          <input type="hidden" name="registration_id" value="new" />
                        `;
    
                        setupDropdownsForNewRow(newRow);
                        setupValidation(newRow);
                        addFileInputListeners();
                        setupTrafficSearchFunctionality(newRow);
                      }
    
                      function setupTrafficSearchFunctionality(row) {
                      const searchInput = row.querySelector('.traffic-search-input');
                      if (!searchInput) {
                        console.warn('Traffic search input not found in the row');
                        return;
                      }
    
                      console.log('Setting up traffic search functionality for:', searchInput);
    
                      searchInput.addEventListener('focus', (event) => {
                      console.log('Focus event triggered on:', event.target);
                      activeSearchInput = searchInput;
    
                      // Reset read-only state for all fields in this row
                      const fieldsToReset = ['EMIRATES_TRF_FILE_NO', 'REGISTERED_EMIRATES', 'FEDERAL_TRF_FILE_NO', 'REG_COMPANY_NAME', 'TRADE_LICENSE_NO'];
                      fieldsToReset.forEach(fieldName => {
                        const input = row.querySelector(`input[name="${fieldName}"]`);
                        if (input) {
                          input.readOnly = false;
                          input.classList.remove('read-only-field');
                        }
                      });
    
                      fetchAndPopulateTrafficFileResults(searchInput);
                      });
    
                      searchInput.addEventListener('input', (event) => {
                        console.log('Input event triggered on:', event.target);
                        fetchAndPopulateTrafficFileResults(searchInput);
                        });
                      }


                      function setupValidation(row) {
                        console.log('Setting up validation for row:', row);
                        // Add your validation logic here if needed
                      }
                      
                      function initializeRegistrationFileInput() {
                        console.log('Initializing registration file input');
                        const registrationTable = document.getElementById('registrationTable');
                        if (registrationTable) {
                          const fileInputs = registrationTable.querySelectorAll('input[type="file"]');
                          console.log('Registration file inputs:', fileInputs);
                          fileInputs.forEach(input => {
                            input.addEventListener('change', function() {
                              console.log('Registration file input changed');
                              handleFileSelection(this);
                            });
                          });
                        } else {
                          console.warn('Registration table not found');
                        }
                      }
                      
                      function reinitializeFileInputs() {
                        console.log('Reinitializing all file inputs');
                        addFileInputListeners();
                        initializeRegistrationFileInput();
                      }
                      
                      // Modify the addRegistrationRow function
                      const originalAddRegistrationRow = addRegistrationRow;
                      addRegistrationRow = function() {
                        originalAddRegistrationRow();
                        console.log('Registration row added, reinitializing file inputs');
                        reinitializeFileInputs();
                      };
                      
                      // Add a mutation observer to watch for changes in the registration table
                      const registrationTableObserver = new MutationObserver((mutations) => {
                        mutations.forEach((mutation) => {
                          if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                            console.log('Registration table changed, reinitializing file inputs');
                            reinitializeFileInputs();
                          }
                        });
                      });
                      
                      document.addEventListener('DOMContentLoaded', function() {
                        console.log('DOM fully loaded');
                        reinitializeFileInputs();
                      
                        const registrationTable = document.getElementById('registrationTable');
                        if (registrationTable) {
                          registrationTableObserver.observe(registrationTable, { childList: true, subtree: true });
                        }
                      });
    
    
                    
    
                      const globalSearchResults = document.getElementById('globalTrafficSearchResults');
                      const closeIcons = globalSearchResults.querySelector('.traffic-close-icon');
    
                      closeIcons.addEventListener('click', (e) => {
                        console.log('Close icon clicked');
                        e.stopPropagation();
                        hideTrafficSearchResults();
                      });
    
                      document.addEventListener('click', (event) => {
                        if (!event.target.closest('.traffic-search-input') && !event.target.closest('#globalTrafficSearchResults')) {
                        hideTrafficSearchResults();
                        }
                      });
    
                      async function fetchAndPopulateTrafficFileResults(searchInput) {
                        console.log('Fetching and populating traffic file results');
                        try {
                          await fetchTrafficFileInfo();
                          filterAndDisplayTrafficFileResults(searchInput);
                          showTrafficSearchResults();
                        } catch (error) {
                        console.error('Error fetching traffic file info:', error);
                        }
                      }
    
                      function filterAndDisplayTrafficFileResults(searchInput) {
                        console.log('Filtering and displaying traffic file results');
                        const searchTerm = searchInput.value.toLowerCase();
                        const filteredInfo = trafficFileInfo.filter(info =>
                          info.TRAFFIC_FILE_NO.toLowerCase().includes(searchTerm)
                      );
    
                      console.log('Filtered info:', filteredInfo);
    
                      const searchResults = globalSearchResults.querySelector('.traffic-search-results tbody');
                      searchResults.innerHTML = '';
                      filteredInfo.forEach((info) => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                              <td>${info.TRAFFIC_FILE_NO}</td>
                              <td>${info.COMPANY_NAME}</td>
                              <td>${info.TRADE_LICENSE_NO}</td>
                              <td>${info.EMIRATES}</td>
                              <td>${info.FEDERAL_TRAFFIC_FILE_NO}</td>
                        `;
                        tr.addEventListener('click', function (e) {
                        console.log('Search result clicked');
                        e.stopPropagation();
                        populateTrafficRegistrationFields(activeSearchInput, info);
                        hideTrafficSearchResults();
                      });
                      searchResults.appendChild(tr);
                      });
                      }
    
                      function showTrafficSearchResults() {
                        console.log('Showing traffic search results');
                        globalSearchResults.style.display = 'block';
                      }
    
                      function hideTrafficSearchResults() {
                        console.log('Hiding traffic search results');
                        globalSearchResults.style.display = 'none';
                      }
    
    
                      async function fetchTrafficFileInfo() {
                        if (trafficFileInfo.length === 0) {
                        console.log('Fetching traffic file info from API');
                        try {
                        const response = await fetch('http://127.0.0.1:8000/api/traffic-file-info');
                        if (!response.ok) {
                          throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        trafficFileInfo = await response.json();
                        console.log('Fetched traffic file info:', trafficFileInfo);
                        } catch (error) {
                        console.error('Error fetching traffic file info:', error);
                        }
                        } else {
                        console.log('Using cached traffic file info');
                        }
                        return trafficFileInfo;
                      }
    
                    
                      function populateTrafficRegistrationFields(searchInput, info) {
                        console.log('Populating traffic registration fields with:', info);
                        const row = searchInput.closest('tr');
    
                        // Populate and make fields read-only
                        const fieldsToPopulate = [
                            { name: 'EMIRATES_TRF_FILE_NO', value: info.TRAFFIC_FILE_NO },
                            { name: 'REGISTERED_EMIRATES', value: info.EMIRATES },
                            { name: 'FEDERAL_TRF_FILE_NO', value: info.FEDERAL_TRAFFIC_FILE_NO },
                            { name: 'REG_COMPANY_NAME', value: info.COMPANY_NAME },
                            { name: 'TRADE_LICENSE_NO', value: info.TRADE_LICENSE_NO }
                        ];
    
                        fieldsToPopulate.forEach(field => {
                          const input = row.querySelector(`input[name="${field.name}"]`);
                          if (input) {
                            input.value = field.value;
                            input.readOnly = true;
                            input.classList.add('read-only-field');
                          }
                        });
    
                        // Add event listener to EmiratesTrafficFileNumber input
                          const trafficFileInput = row.querySelector('input[name="EMIRATES_TRF_FILE_NO"]');
                          trafficFileInput.addEventListener('focus', function() {
                          // Remove read-only attribute when focused
                          fieldsToPopulate.forEach(field => {
                          const input = row.querySelector(`input[name="${field.name}"]`);
                            if (input) {
                              input.readOnly = false;
                              input.classList.remove('read-only-field');
                            }
                          });
                        });
                      }
    
    
                      // Make sure this function is called when the page loads
                      document.addEventListener('DOMContentLoaded', () => {
                        console.log('DOM content loaded');
                        const existingRows = document.querySelectorAll('#registrationTable tbody tr');
                        existingRows.forEach(row => setupTrafficSearchFunctionality(row));
                      });
    
                      function addRoadtollRow() {
                          const tbody = document.querySelector('#roadtollTable tbody');
                          const newRow = tbody.insertRow();
                          newRow.innerHTML = `
                            <td><select class="form-control" name="AE_EMIRATES_LOOKUP_NAME" style="background-color: #ffff76; color: black"><option value=""></option></select></td>
                            <td><select class="form-control" name="TOLL TYPE_LOOKUP_NAME" style="background-color: #ffff76; color: black"><option value=""></option></select></td>
                            <td><input type="number" class="form-control" name="ACCOUNT_NO" /></td>
                            <td><input type="number" class="form-control" name="TAG_NO" /></td>
                            <td><input type="date" class="form-control" name="ACTIVATION_DATE" style="background-color: #ffff76; color: black" /></td>
                            
                            <td><input type="date" class="form-control" name="ACTIVATION_END_DATE"  style="background-color: #ffff76; color: black"/></td>
                            <td><select class="form-control" name="CURRENT STATUS_LOOKUP_NAME" style="background-color: #ffff76; color: black"><option value=""></option></select></td>
                            <td><input type="file" class="form-control" name="RoadtollAttachments" /></td>
                            <input type="hidden" name="roadtoll_id" value="new" />
                          `;
    
                          setupDropdownsForNewRow(newRow);
    
                          const inputs = newRow.querySelectorAll('input[required], select[required]');
                          inputs.forEach(input => {
                            input.addEventListener('blur', () => {
                              validateRegistrationField(input);
                            });
                          });
    
                          addFileInputListeners();
                      }
    
                      function addAllocationRow() {
                        const tbody = document.querySelector('#allocationTable tbody');
                        const newRow = tbody.insertRow();
                        newRow.innerHTML = `
                           <td><select class="form-control" name="COMPANY NAME_LOOKUP_NAME"style="background-color: #ffff76; color: black"><option value=""></option></select></td>
                                <td><select class="form-control" name="DIVISIONS_LOOKUP_NAME"style="background-color: #ffff76; color: black"><option value=""></option></select></td>
                                <td><select class="form-control" name="OPERATING_LOCATION_ALLOCATION_LOOKUP_NAME"style="background-color: #ffff76; color: black"><option value=""></option></select></td>
                                <td><select class="form-control" name="AE_EMIRATES_LOOKUP_NAME"style="background-color: #ffff76; color: black"><option value=""></option></select></td>
                               
                                <td><input type="text" class="form-control" name="APPICATION_USAGE" style="background-color: #ffff76; color: black" /></td>
                                <td><input type="date" class="form-control" name="ALLOCATION_DATE" style="background-color: #ffff76; color: black" /></td>
                                <td><input type="date" class="form-control" name="ALLOCATION_END_DATE" style="background-color: #ffff76; color: black" /></td>
                          <td><input type="file" class="form-control" name="attachment" /></td>
                          <input type="hidden" name="allocation_id" value="new" />
                        `;
    
                        setupDropdownsForNewRow(newRow);
    
                        const inputs = newRow.querySelectorAll('input[required], select[required]');
                        inputs.forEach(input => {
                          input.addEventListener('blur', () => {
                            validateAllocationField(input);
                          });
                        });
    
                        addFileInputListeners();
                      }
    
    
    
                      document.getElementById('addRow').addEventListener('click', function () {
                        if (isPopulatedData && !isEditMode) {
                          alert("Please enable editing first.");
                            return;
                        }
                        const activeTab = document.querySelector('.tab.active').getAttribute('data-tab');
    
                          switch(activeTab) {
                            case 'insurance':
                              addInsuranceRow();
                              break;
                           
                           
                            case 'registration':
                              addRegistrationRow();
                              break;
                            
                            case 'roadtoll':
                              addRoadtollRow();
                              break;
                            
                            case 'allocation':
                              addAllocationRow();
                              break;
                          }
                      });
    
                      document.getElementById('removeRow').addEventListener('click', function() {
                              if (isPopulatedData && !isEditMode) {
                                alert("Please enable editing first.");
                                return;
                              }
    
                              const activeTab = document.querySelector('.tab.active').getAttribute('data-tab');
                              let tbody;
    
    
                              console.log('Active tab:', activeTab);
    
                              switch(activeTab) {
                                case 'insurance':
                                  tbody = document.querySelector('#insuranceTable tbody');
                                  break;
                               
                                
                                case 'registration':
                                  tbody = document.querySelector('#registrationTable tbody');
                                  break;
                               
                                case 'roadtoll':
                                  tbody = document.querySelector('#roadtollTable tbody');
                                  break;
                                
                                case 'allocation':
                                  tbody = document.querySelector('#allocationTable tbody');
                                  break;
                              }
    
                              console.log('Selected tbody:', tbody);
    
                              if (tbody && tbody.rows.length > 0) {
                                const lastRow = tbody.rows[tbody.rows.length - 1];
                                const inputs = lastRow.querySelectorAll('input, select');
                                let isEmpty = true;
    
                                console.log('Number of inputs in last row:', inputs.length);
    
                                for (let input of inputs) {
                                  console.log('Input value:', input.value);
                                  if (input.value.trim() !== '' && input.type !== 'hidden') {
                                    isEmpty = false;
                                    break;
                                  }
                                }
    
                                console.log('Is row empty:', isEmpty);
    
                                if (isEmpty) {
                                  tbody.deleteRow(-1);
                                  console.log('Row deleted');
                                } else {
                                  alert('Cannot delete row with data. Please clear the row first.');
                                }
                              } else {
                                console.log('No rows to delete');
                              }
                      });
    
                      document.getElementById('newForm').addEventListener('click', function() {
                        clearForm();
                        location.reload();
                        isEditMode = true; // This will refresh the page
                      });
    
    
                      function debounce(func, wait) {
                        let timeout;
                        return function executedFunction(...args) {
                            const later = () => {
                                clearTimeout(timeout);
                                func(...args);
                            };
                            clearTimeout(timeout);
                            timeout = setTimeout(later, wait);
                        };
                      }
    
                      function setupDeleteListeners() {
                        document.querySelectorAll('.remove-file').forEach(removeIcon => {
                            removeIcon.addEventListener('click', debounce(function(event) {
                                const modelName = event.target.dataset.model;
                                const instanceId = event.target.dataset.instance;
                                const fileIndex = event.target.dataset.index;
                                const fileName = event.target.dataset.fileName;
    
                                deleteFile(modelName, instanceId, fileIndex, fileName);
                            }, 250));
                        });
                      }
    
                      async function deleteFile(modelName, instanceId, fileIndex, fileName) {
                        console.log(`Attempting to delete file: ${fileName} from ${modelName}`);
                        if (confirm(`Are you sure you want to delete ${fileName}?`)) {
                            try {
                                const response = await fetch(`/api/delete-file/${modelName}/${instanceId}/${fileIndex}`, {
                                    method: 'DELETE',
                                });
                                const data = await response.json();
                                console.log('Server response:', data);
                                if (response.ok) {
                                    console.log('File deletion successful on server');
                                    const fileItems = document.querySelectorAll('.file-item');
                                    const fileItem = Array.from(fileItems).find(item => {
                                        const removeIcon = item.querySelector('.remove-file');
                                        return removeIcon &&
                                              removeIcon.dataset.fileName === fileName &&
                                              removeIcon.dataset.model === modelName &&
                                              removeIcon.dataset.instance === instanceId;
                                    });
    
                                    console.log('File item to remove:', fileItem);
                                    if (fileItem) {
                                        fileItem.remove();
                                        console.log('File item removed from DOM');
                                    } else {
                                        console.log('File item not found in DOM');
                                    }
                                    alert("File deleted successfully");
                                    document.dispatchEvent(new CustomEvent('fileDeleted', { detail: { modelName, instanceId, fileName } }));
                                    console.log('Custom event dispatched');
                                } else {
                                    console.error("Error deleting file:", data.message);
                                    alert("Error deleting file. Please try again.");
                                }
                            } catch (error) {
                                console.error('Error:', error);
                                alert("An error occurred while deleting the file. Please try again.");
                            }
                          }
                      }
    
                      function getActiveDataTables() {
                        const activeTables = [];
                        const tables = ['insurance','registration','roadtoll','allocation'];
    
                        tables.forEach(table => {
                          if (document.querySelector(`#${table}Table tbody tr`)) {
                            activeTables.push(table);
                          }
                        });
    
                        return activeTables;
                      }
                      function validateRegistrationField(input) {
                        if (!input.value.trim()) {
                          input.classList.add('is-invalid');
                          if (!input.nextElementSibling || !input.nextElementSibling.classList.contains('invalid-feedback')) {
                            const errorMessage = document.createElement('div');
                            errorMessage.className = 'invalid-feedback';
                            errorMessage.textContent = `${input.name} is required`;
                            input.parentNode.insertBefore(errorMessage, input.nextSibling);
                          }
                          return false;
                        } else {
                          input.classList.remove('is-invalid');
                          if (input.nextElementSibling && input.nextElementSibling.classList.contains('invalid-feedback')) {
                            input.nextElementSibling.remove();
                          }
                          return true;
                        }
                }
                     
                      function validateAllocationTable() {
                        const allocationRows = document.querySelectorAll('#allocationTable tbody tr');
                        let isValid = true;
  
                        allocationRows.forEach((row) => {
                          const fields = [
                            'COMPANY NAME_LOOKUP_NAME',
                            'DIVISIONS_LOOKUP_NAME',
                            'OPERATING_LOCATION_ALLOCATION_LOOKUP_NAME',
                            'AE_EMIRATES_LOOKUP_NAME',
                            'APPICATION_USAGE',
                            'ALLOCATION_DATE',
                            'ALLOCATION_END_DATE'
                          ];
  
                          fields.forEach(field => {
                            const input = row.querySelector(`[name="${field}"]`);
                            if (input && !input.value.trim()) {
                              isValid = false;
                              input.classList.add('is-invalid');
                            } else if (input) {
                              input.classList.remove('is-invalid');
                            }
                          });
                        });
  
                        return {
                          isValid,
                          errorMessage: isValid ? '' : 'Please fill in all required fields in the Allocation Info.'
                        };
                      }
  
    
                      function validateInsuranceTable() {
                        const insuranceRows = document.querySelectorAll('#insuranceTable tbody tr');
                        let isValid = true;
                        insuranceRows.forEach((row) => {
                          const fields = [
                            'INSURANCE_COMPANY',
                            'POLICY_NO',
                            'POLICY_DATE',
                            'POLICY_EXPIRY_DATE',
                          ];
    
                          fields.forEach(field => {
                            const input = row.querySelector(`[name="${field}"]`);
                            if (input && !input.value.trim()) {
                              isValid = false;
                              input.classList.add('is-invalid');
                            } else if (input) {
                                input.classList.remove('is-invalid');
                              }
                          });
                        });
                        return {
                          isValid,
                          errorMessage: isValid ? '' : 'Please fill in all required fields in the Insurance Info.'
                        };
                      }
    
                      function validateRegistrationTable() {
                              const registrationRows = document.querySelectorAll('#registrationTable tbody tr');
                              let isValid = true;
    
                              registrationRows.forEach((row) => {
                                const fields = [
                                  'EMIRATES_TRF_FILE_NO',
                                  'REGISTERED_EMIRATES',
                                  'FEDERAL_TRF_FILE_NO',
                                  'REG_COMPANY_NAME',
                                  'TRADE_LICENSE_NO',
                                ];
    
                                fields.forEach(field => {
                                  const input = row.querySelector(`[name="${field}"]`);
                                  if (input && !input.value.trim()) {
                                    isValid = false;
                                    input.classList.add('is-invalid');
                                  } else if (input) {
                                    input.classList.remove('is-invalid');
                                  }
                                });
                              });
    
                              return {
                                isValid,
                                errorMessage: isValid ? '' : 'Please fill in all required fields in the Registration Info.'
                              };
                      }
    
    
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js"></script>
    <script src="https://unpkg.com/boxicons@2.1.4/dist/boxicons.js"></script>
    </body>
    </html>
    
  </body>
</html>








   